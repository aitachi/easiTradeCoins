# EasiTradeCoins é£æ§ç³»ç»Ÿå…¨é¢æŠ€æœ¯è§£æ

> **æ–‡æ¡£ä½œè€…**: Aitachi
> **è”ç³»é‚®ç®±**: 44158892@qq.com
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-02
> **é€‚ç”¨è¯»è€…**: é£æ§å·¥ç¨‹å¸ˆã€åç«¯å¼€å‘è€…ã€å®‰å…¨æ¶æ„å¸ˆ
> **æŠ€æœ¯éš¾åº¦**: â­â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

1. [é£æ§ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#1-é£æ§ç³»ç»Ÿæ¶æ„æ€»è§ˆ)
2. [è®¢å•é£æ§ä½“ç³»](#2-è®¢å•é£æ§ä½“ç³»)
3. [æç°é£æ§ä½“ç³»](#3-æç°é£æ§ä½“ç³»)
4. [åæ´—é’±æ£€æµ‹æœºåˆ¶](#4-åæ´—é’±æ£€æµ‹æœºåˆ¶)
5. [é£é™©è¯„åˆ†ç³»ç»Ÿ](#5-é£é™©è¯„åˆ†ç³»ç»Ÿ)
6. [è´¦æˆ·è¡Œä¸ºç›‘æ§](#6-è´¦æˆ·è¡Œä¸ºç›‘æ§)
7. [æ•°æ®åº“è®¾è®¡ä¸ç´¢å¼•](#7-æ•°æ®åº“è®¾è®¡ä¸ç´¢å¼•)
8. [å®æ—¶ç›‘æ§ä¸å‘Šè­¦](#8-å®æ—¶ç›‘æ§ä¸å‘Šè­¦)

---

## 1. é£æ§ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 1.1 æ•´ä½“æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EasiTradeCoins é£æ§ç³»ç»Ÿæ¶æ„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è¡Œä¸ºå±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ä¸‹å•è¡Œä¸º       â€¢ æç°è¡Œä¸º       â€¢ äº¤æ˜“è¡Œä¸º                   â”‚
â”‚  â€¢ ç™»å½•è¡Œä¸º       â€¢ å……å€¼è¡Œä¸º       â€¢ è·Ÿå•è¡Œä¸º                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é£æ§æ‹¦æˆªå±‚ (Entry Gate)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¯·æ±‚å‰ç½®éªŒè¯                                                    â”‚
â”‚  â”œâ”€â”€ é€Ÿç‡é™åˆ¶ (Rate Limiting)                                   â”‚
â”‚  â”œâ”€â”€ IPé»‘åå•æ£€æŸ¥                                               â”‚
â”‚  â”œâ”€â”€ è´¦æˆ·çŠ¶æ€éªŒè¯                                               â”‚
â”‚  â””â”€â”€ JWTè®¤è¯æ£€æŸ¥                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ ¸å¿ƒé£æ§å¼•æ“ (RiskManager)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¢å•é£æ§æ¨¡å—                                                    â”‚
â”‚  â”œâ”€â”€ ValidateOrder()         - è®¢å•é‡‘é¢/ä»·æ ¼/é¢‘ç‡éªŒè¯           â”‚
â”‚  â”œâ”€â”€ checkPriceDeviation()   - ä»·æ ¼åç¦»æ£€æµ‹ (10%é˜ˆå€¼)          â”‚
â”‚  â”œâ”€â”€ checkOrderFrequency()   - è®¢å•é¢‘ç‡é™åˆ¶ (10ç¬”/ç§’)          â”‚
â”‚  â””â”€â”€ DetectSelfTrading()     - è‡ªæˆäº¤æ£€æµ‹                      â”‚
â”‚                                                                  â”‚
â”‚  æç°é£æ§æ¨¡å—                                                    â”‚
â”‚  â”œâ”€â”€ ValidateWithdrawal()           - æç°éªŒè¯æ€»å…¥å£            â”‚
â”‚  â”œâ”€â”€ KYCç­‰çº§æ£€æŸ¥                     - 0/1/2ä¸‰çº§é™é¢           â”‚
â”‚  â”œâ”€â”€ æ¯æ—¥é™é¢è®¡ç®—                    - ç´¯è®¡ä»Šæ—¥æç°            â”‚
â”‚  â””â”€â”€ detectSuspiciousWithdrawal()   - å¯ç–‘æ¨¡å¼æ£€æµ‹            â”‚
â”‚                                                                  â”‚
â”‚  è´¦æˆ·ç›‘æ§æ¨¡å—                                                    â”‚
â”‚  â”œâ”€â”€ DetectRelatedAccounts() - IPå…³è”è´¦æˆ·æ£€æµ‹                  â”‚
â”‚  â”œâ”€â”€ CalculateRiskScore()    - ç»¼åˆé£é™©è¯„åˆ† (0-100åˆ†)          â”‚
â”‚  â”œâ”€â”€ FreezeAccount()         - è´¦æˆ·å†»ç»“                        â”‚
â”‚  â””â”€â”€ UnfreezeAccount()       - è´¦æˆ·è§£å†»                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®æŒä¹…åŒ–å±‚ (Database)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ audit_logs          - å®¡è®¡æ—¥å¿—è¡¨                             â”‚
â”‚  â€¢ risk_events         - é£é™©äº‹ä»¶è®°å½•è¡¨                         â”‚
â”‚  â€¢ blacklist           - é»‘åå•è¡¨ (IP/åœ°å€/ç”¨æˆ·)                â”‚
â”‚  â€¢ rate_limits         - é€Ÿç‡é™åˆ¶è®°å½•è¡¨                         â”‚
â”‚  â€¢ risk_alerts         - é£é™©å‘Šè­¦è¡¨                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‘Šè­¦ä¸å“åº”å±‚ (Alert)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ é‚®ä»¶å‘Šè­¦           â€¢ çŸ­ä¿¡é€šçŸ¥           â€¢ é’‰é’‰/ä¼ä¸šå¾®ä¿¡      â”‚
â”‚  â€¢ é£æ§å¤§ç›˜           â€¢ å®æ—¶ç›‘æ§           â€¢ äººå·¥å®¡æ ¸é˜Ÿåˆ—       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 é£æ§æ ¸å¿ƒç»„ä»¶

**æ–‡ä»¶ä½ç½®:** `go-backend/internal/security/risk_manager.go` (282è¡Œ)

```go
// RiskManager handles risk management and security
type RiskManager struct {
    maxOrderSize          decimal.Decimal                  // å•ç¬”è®¢å•æœ€å¤§é‡‘é¢: 1,000,000 USDT
    dailyWithdrawalLimit  map[int]decimal.Decimal         // KYCç­‰çº§ -> æ¯æ—¥é™é¢æ˜ å°„
    apiRateLimit          int                              // APIé€Ÿç‡é™åˆ¶: 100æ¬¡/åˆ†é’Ÿ
    orderRateLimit        int                              // è®¢å•é€Ÿç‡é™åˆ¶: 10ç¬”/ç§’
}
```

**åˆå§‹åŒ–é…ç½®:**

```go
// go-backend/internal/security/risk_manager.go:27-38

func NewRiskManager() *RiskManager {
    return &RiskManager{
        maxOrderSize: decimal.NewFromInt(1000000),  // 100ä¸‡USDT
        dailyWithdrawalLimit: map[int]decimal.Decimal{
            0: decimal.NewFromInt(1000),      // æœªè®¤è¯: 1,000 USDT/å¤©
            1: decimal.NewFromInt(10000),     // åˆçº§è®¤è¯: 10,000 USDT/å¤©
            2: decimal.NewFromInt(100000),    // é«˜çº§è®¤è¯: 100,000 USDT/å¤©
        },
        apiRateLimit:   100,  // 100æ¬¡/åˆ†é’Ÿ
        orderRateLimit: 10,   // 10ç¬”/ç§’
    }
}
```

**é…ç½®è¯´æ˜:**

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ | é£æ§ç›®çš„ |
|--------|--------|------|---------|
| `maxOrderSize` | 1,000,000 USDT | å•ç¬”è®¢å•ä¸Šé™ | é˜²æ­¢å·¨é¢è®¢å•å†²å‡»å¸‚åœº/é˜²æ­¢è¯¯æ“ä½œ |
| `dailyWithdrawalLimit[0]` | 1,000 USDT | æœªè®¤è¯ç”¨æˆ·æ¯æ—¥é™é¢ | é™åˆ¶æœªå®åç”¨æˆ·èµ„é‡‘æµåŠ¨ |
| `dailyWithdrawalLimit[1]` | 10,000 USDT | åˆçº§KYCæ¯æ—¥é™é¢ | å¹³è¡¡ç”¨æˆ·ä½“éªŒä¸é£æ§éœ€æ±‚ |
| `dailyWithdrawalLimit[2]` | 100,000 USDT | é«˜çº§KYCæ¯æ—¥é™é¢ | å¤§é¢ç”¨æˆ·éœ€è¦æ›´ä¸¥æ ¼å®¡æ ¸ |
| `apiRateLimit` | 100æ¬¡/åˆ†é’Ÿ | APIè°ƒç”¨é¢‘ç‡ | é˜²æ­¢APIæ»¥ç”¨/DDoSæ”»å‡» |
| `orderRateLimit` | 10ç¬”/ç§’ | ä¸‹å•é¢‘ç‡ | é˜²æ­¢é«˜é¢‘åˆ·å•/æ¶æ„ä¸‹å• |

---

## 2. è®¢å•é£æ§ä½“ç³»

### 2.1 è®¢å•é£æ§æµç¨‹å›¾

```
ç”¨æˆ·å‘èµ·ä¸‹å•è¯·æ±‚
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrderService.CreateOrder()                     â”‚
â”‚ æ–‡ä»¶: services/order_service.go:35-104        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [1] æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ database.DB.First(&user, order.UserID)         â”‚
â”‚ â†’ è·å–ç”¨æˆ·KYCç­‰çº§ã€è´¦æˆ·çŠ¶æ€                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [2] é£æ§éªŒè¯ (æ ¸å¿ƒå…¥å£)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ riskManager.ValidateOrder(ctx, order, &user)   â”‚
â”‚ æ–‡ä»¶: security/risk_manager.go:41-64          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                     â”‚
        â–¼ [2.1] è®¢å•é‡‘é¢æ£€æŸ¥                 â–¼ [2.2] ä»·æ ¼åç¦»æ£€æŸ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ orderValue > maxSize? â”‚           â”‚ checkPriceDeviation() â”‚
â”‚ â†’ 1,000,000 USDT      â”‚           â”‚ â†’ åç¦»åº¦ â‰¤ 10%        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                     â”‚
        â–¼ é€šè¿‡                               â–¼ é€šè¿‡
        â”‚                                     â”‚
        â–¼ [2.3] è®¢å•é¢‘ç‡æ£€æŸ¥                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ checkOrderFrequency()                          â”‚
â”‚ â†’ æŸ¥è¯¢æœ€è¿‘1ç§’å†…ä¸‹å•æ•°                         â”‚
â”‚ â†’ count >= 10 ? æ‹’ç» : é€šè¿‡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [2.4] è´¦æˆ·çŠ¶æ€æ£€æŸ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user.Status != 1 (æ´»è·ƒ) ?                      â”‚
â”‚ â†’ å†»ç»“/åœç”¨è´¦æˆ·æ‹’ç»äº¤æ˜“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ æ‰€æœ‰æ£€æŸ¥é€šè¿‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®åº“äº‹åŠ¡å¼€å§‹ (database.DB.Transaction)       â”‚
â”‚ â”œâ”€ éªŒè¯ä½™é¢å……è¶³                                â”‚
â”‚ â”œâ”€ å†»ç»“è®¢å•èµ„äº§                                â”‚
â”‚ â”œâ”€ æ’®åˆå¼•æ“å¤„ç†                                â”‚
â”‚ â”œâ”€ è‡ªæˆäº¤æ£€æµ‹ (DetectSelfTrading)             â”‚
â”‚ â””â”€ ä¿å­˜è®¢å•å’Œæˆäº¤è®°å½•                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ äº‹åŠ¡æäº¤æˆåŠŸ
    è®¢å•åˆ›å»ºæˆåŠŸ
```

### 2.2 è®¢å•é‡‘é¢éªŒè¯

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:41-46

func (rm *RiskManager) ValidateOrder(ctx context.Context, order *models.Order, user *models.User) error {
    // [æ£€æŸ¥1] è®¢å•é‡‘é¢é™åˆ¶
    orderValue := order.Quantity.Mul(order.Price)  // è®¡ç®—è®¢å•æ€»ä»·å€¼
    if orderValue.GreaterThan(rm.maxOrderSize) {
        return fmt.Errorf("order size exceeds maximum allowed: %s", rm.maxOrderSize.String())
    }

    // ... åç»­æ£€æŸ¥
}
```

**éªŒè¯é€»è¾‘:**

```
è®¢å•æ€»ä»·å€¼ = æ•°é‡ Ã— ä»·æ ¼

ç¤ºä¾‹1: ä¹°å…¥è®¢å•
- æ•°é‡: 0.5 BTC
- ä»·æ ¼: 50,000 USDT/BTC
- è®¢å•æ€»ä»·å€¼: 0.5 Ã— 50,000 = 25,000 USDT
- éªŒè¯ç»“æœ: 25,000 < 1,000,000 âœ… é€šè¿‡

ç¤ºä¾‹2: å¼‚å¸¸å¤§å•
- æ•°é‡: 50 BTC
- ä»·æ ¼: 50,000 USDT/BTC
- è®¢å•æ€»ä»·å€¼: 50 Ã— 50,000 = 2,500,000 USDT
- éªŒè¯ç»“æœ: 2,500,000 > 1,000,000 âŒ æ‹’ç»
- é”™è¯¯ä¿¡æ¯: "order size exceeds maximum allowed: 1000000"
```

**è§¦å‘çš„ç”¨æˆ·è¡Œä¸º:**

- âœ… æ­£å¸¸ä¸‹å•: å°é¢/ä¸­é¢è®¢å•é¡ºåˆ©é€šè¿‡
- âŒ å·¨é¢ä¸‹å•: å•ç¬”è¶…è¿‡100ä¸‡USDTè¢«æ‹¦æˆª
- âŒ è¯¯æ“ä½œ: ç”¨æˆ·è¾“å…¥é”™è¯¯æ•°é‡ (å¦‚100 BTCè¯¯è¾“å…¥ä¸º1000 BTC)

**ä¸šåŠ¡ä»·å€¼:**

1. **é˜²æ­¢å¸‚åœºå†²å‡»**: é¿å…è¶…å¤§è®¢å•ç¬é—´å½±å“å¸‚åœºä»·æ ¼
2. **ç”¨æˆ·ä¿æŠ¤**: é˜²æ­¢ç”¨æˆ·è¯¯æ“ä½œå¯¼è‡´å·¨é¢æŸå¤±
3. **æµåŠ¨æ€§ä¿æŠ¤**: é˜²æ­¢å•ä¸€è®¢å•æ¶ˆè€—æ‰€æœ‰æµåŠ¨æ€§

---

### 2.3 ä»·æ ¼åç¦»æ£€æµ‹

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:67-91

func (rm *RiskManager) checkPriceDeviation(order *models.Order) error {
    // [1] å¸‚ä»·å•è·³è¿‡æ£€æŸ¥
    if order.Type == models.OrderTypeMarket {
        return nil
    }

    // [2] è·å–æœ€æ–°æˆäº¤ä»·
    var lastTrade models.Trade
    if err := database.DB.Where("symbol = ?", order.Symbol).
        Order("trade_time DESC").
        First(&lastTrade).Error; err != nil {
        // æ— å†å²æˆäº¤,å…è®¸ä»»ä½•ä»·æ ¼
        return nil
    }

    // [3] è®¡ç®—ä»·æ ¼åç¦»ç‡
    maxDeviation := decimal.NewFromFloat(0.1)  // 10%é˜ˆå€¼
    priceDiff := order.Price.Sub(lastTrade.Price).Abs()
    deviationPercent := priceDiff.Div(lastTrade.Price)

    // [4] è¶…è¿‡é˜ˆå€¼åˆ™æ‹’ç»
    if deviationPercent.GreaterThan(maxDeviation) {
        return fmt.Errorf("price deviates more than 10%% from market price")
    }

    return nil
}
```

**è®¡ç®—å…¬å¼:**

```
åç¦»ç‡ = |è®¢å•ä»·æ ¼ - æœ€æ–°æˆäº¤ä»·| / æœ€æ–°æˆäº¤ä»·

ç¤ºä¾‹1: æ­£å¸¸ä¹°å•
- æœ€æ–°æˆäº¤ä»·: 50,000 USDT
- è®¢å•ä»·æ ¼: 51,000 USDT (ä¹°å•,ç•¥é«˜äºå¸‚åœºä»·)
- åç¦»ç‡: |51,000 - 50,000| / 50,000 = 2%
- éªŒè¯ç»“æœ: 2% < 10% âœ… é€šè¿‡

ç¤ºä¾‹2: å¼‚å¸¸ä¹°å•
- æœ€æ–°æˆäº¤ä»·: 50,000 USDT
- è®¢å•ä»·æ ¼: 60,000 USDT (ä¹°å•,è¿œé«˜äºå¸‚åœºä»·)
- åç¦»ç‡: |60,000 - 50,000| / 50,000 = 20%
- éªŒè¯ç»“æœ: 20% > 10% âŒ æ‹’ç»
- é”™è¯¯ä¿¡æ¯: "price deviates more than 10% from market price"

ç¤ºä¾‹3: å¼‚å¸¸å–å•
- æœ€æ–°æˆäº¤ä»·: 50,000 USDT
- è®¢å•ä»·æ ¼: 40,000 USDT (å–å•,è¿œä½äºå¸‚åœºä»·)
- åç¦»ç‡: |40,000 - 50,000| / 50,000 = 20%
- éªŒè¯ç»“æœ: 20% > 10% âŒ æ‹’ç»
```

**è§¦å‘çš„ç”¨æˆ·è¡Œä¸º:**

| åœºæ™¯ | ç”¨æˆ·è¡Œä¸º | è®¢å•ä»·æ ¼ | å¸‚åœºä»· | åç¦»ç‡ | ç»“æœ |
|------|---------|---------|--------|--------|------|
| æ­£å¸¸äº¤æ˜“ | æŒ‚é™ä»·ä¹°å• | 51,000 | 50,000 | 2% | âœ… é€šè¿‡ |
| æ­£å¸¸äº¤æ˜“ | æŒ‚é™ä»·å–å• | 49,000 | 50,000 | 2% | âœ… é€šè¿‡ |
| è¯¯æ“ä½œ | ä»·æ ¼è¾“å…¥é”™è¯¯ | 5,000 | 50,000 | 90% | âŒ æ‹’ç» |
| è¯¯æ“ä½œ | å¤šè¾“å…¥ä¸€ä¸ª0 | 500,000 | 50,000 | 900% | âŒ æ‹’ç» |
| æ¶æ„æ“ä½œ | æ•…æ„é«˜ä»·ä¹°å…¥ | 100,000 | 50,000 | 100% | âŒ æ‹’ç» |
| æ¶æ„æ“ä½œ | æ•…æ„ä½ä»·å–å‡º | 10,000 | 50,000 | 80% | âŒ æ‹’ç» |

**é˜²æŠ¤ç›®æ ‡:**

1. **é˜²æ­¢ä¹Œé¾™æŒ‡**: ç”¨æˆ·è¾“å…¥é”™è¯¯ä»·æ ¼å¯¼è‡´æ„å¤–æˆäº¤
2. **é˜²æ­¢ä»·æ ¼æ“çºµ**: æ¶æ„ç”¨æˆ·é€šè¿‡æç«¯ä»·æ ¼æ“çºµå¸‚åœº
3. **ä¿æŠ¤ç”¨æˆ·èµ„é‡‘**: é¿å…ç”¨æˆ·ä»¥ä¸åˆ©ä»·æ ¼æˆäº¤

**è®¾è®¡è€ƒé‡:**

```
10%é˜ˆå€¼çš„é€‰æ‹©:
â”œâ”€â”€ å¤ªå° (å¦‚1%): æ­£å¸¸å¸‚åœºæ³¢åŠ¨ä¼šè¢«è¯¯åˆ¤
â”œâ”€â”€ å¤ªå¤§ (å¦‚50%): æ— æ³•æœ‰æ•ˆé˜²æ­¢ä¹Œé¾™æŒ‡
â””â”€â”€ é€‚ä¸­ (10%): å¹³è¡¡ç”¨æˆ·ä½“éªŒä¸é£æ§éœ€æ±‚

ç‰¹æ®Šæƒ…å†µå¤„ç†:
â”œâ”€â”€ å¸‚ä»·å•: è·³è¿‡æ£€æŸ¥ (å› ä¸ºå¸‚ä»·å•æœ¬èº«å°±æ˜¯æ¥å—å¸‚åœºä»·)
â”œâ”€â”€ æ— å†å²æˆäº¤: å…è®¸ä»»ä½•ä»·æ ¼ (æ–°ä¸Šå¸å¯¹,æ— å‚è€ƒä»·æ ¼)
â””â”€â”€ ä»·æ ¼å¿«é€Ÿæ³¢åŠ¨: ä½¿ç”¨æœ€æ–°æˆäº¤ä»·è€Œéæ—¶é—´åŠ æƒä»·æ ¼
```

---

### 2.4 è®¢å•é¢‘ç‡é™åˆ¶

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:94-110

func (rm *RiskManager) checkOrderFrequency(ctx context.Context, userID uint) error {
    // [1] å®šä¹‰æ—¶é—´çª—å£: 1ç§’
    oneSecondAgo := time.Now().Add(-time.Second)

    // [2] æŸ¥è¯¢æ—¶é—´çª—å£å†…çš„è®¢å•æ•°é‡
    var count int64
    if err := database.DB.Model(&models.Order{}).
        Where("user_id = ? AND create_time > ?", userID, oneSecondAgo).
        Count(&count).Error; err != nil {
        return err
    }

    // [3] è¶…è¿‡é˜ˆå€¼åˆ™æ‹’ç»
    if count >= int64(rm.orderRateLimit) {
        return errors.New("order rate limit exceeded")
    }

    return nil
}
```

**é™æµé€»è¾‘:**

```
æ—¶é—´çª—å£: æ»‘åŠ¨çª—å£ (1ç§’)
é™æµé˜ˆå€¼: 10ç¬”è®¢å•

æ—¶é—´è½´ç¤ºä¾‹:
T0         T1         T2         T3         T4
|----------|----------|----------|----------|
   3ç¬”        5ç¬”        2ç¬”        8ç¬”       â† ç´¯è®¡è®¢å•æ•°
   âœ…         âœ…         âœ…         âœ…

T5: ç”¨æˆ·å°è¯•ä¸‹ç¬¬11ç¬”è®¢å•
æŸ¥è¯¢ [T5-1ç§’, T5] çª—å£å†…è®¢å•æ•° = 10ç¬”
éªŒè¯: 10 >= 10 âŒ æ‹’ç»
é”™è¯¯: "order rate limit exceeded"

T6: (1ç§’å) ç”¨æˆ·å†æ¬¡å°è¯•
æŸ¥è¯¢ [T6-1ç§’, T6] çª—å£å†…è®¢å•æ•° = 5ç¬” (æ—©æœŸè®¢å•å·²æ»‘å‡ºçª—å£)
éªŒè¯: 5 < 10 âœ… é€šè¿‡
```

**SQLæ‰§è¡Œé€»è¾‘:**

```sql
-- å®é™…æ‰§è¡Œçš„SQL (ç”±GORMç”Ÿæˆ)
SELECT COUNT(*)
FROM orders
WHERE user_id = ?
  AND create_time > NOW() - INTERVAL 1 SECOND;

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_user_create_time ON orders(user_id, create_time);
```

**è§¦å‘çš„ç”¨æˆ·è¡Œä¸º:**

| ç”¨æˆ·ç±»å‹ | è¡Œä¸ºç‰¹å¾ | 1ç§’å†…è®¢å•æ•° | ç»“æœ |
|---------|---------|------------|------|
| æ™®é€šç”¨æˆ· | æ‰‹åŠ¨ä¸‹å• | 1-2ç¬” | âœ… æ­£å¸¸é€šè¿‡ |
| é«˜é¢‘äº¤æ˜“è€… | å¿«é€Ÿæ“ä½œ | 5-8ç¬” | âœ… æ­£å¸¸é€šè¿‡ |
| é‡åŒ–æœºå™¨äºº | ç¨‹åºåŒ–äº¤æ˜“ | 15ç¬” | âŒ è¶…è¿‡é™åˆ¶ |
| æ¶æ„åˆ·å• | æ•…æ„åˆ·å• | 50ç¬” | âŒ è¶…è¿‡é™åˆ¶ |

**é˜²æŠ¤ç›®æ ‡:**

1. **é˜²æ­¢é«˜é¢‘åˆ·å•**: æ¶æ„ç”¨æˆ·é€šè¿‡åˆ·å•æ“çºµå¸‚åœºæ·±åº¦
2. **é˜²æ­¢ç³»ç»Ÿè¿‡è½½**: é™åˆ¶å•ç”¨æˆ·è®¢å•é‡,ä¿æŠ¤æ’®åˆå¼•æ“æ€§èƒ½
3. **é˜²æ­¢ç¨‹åºåŒ–æ»¥ç”¨**: é™åˆ¶æœªæˆæƒçš„é‡åŒ–äº¤æ˜“æœºå™¨äºº

**ä¼˜åŒ–å»ºè®®:**

```go
// å½“å‰å®ç°: æ•°æ®åº“æŸ¥è¯¢ (æ¯æ¬¡ä¸‹å•éƒ½æŸ¥è¯¢æ•°æ®åº“)
// ä¼˜åŒ–æ–¹æ¡ˆ: ä½¿ç”¨Redisæ»‘åŠ¨çª—å£è®¡æ•°å™¨

import "github.com/redis/go-redis/v9"

func (rm *RiskManager) checkOrderFrequencyWithRedis(userID uint) error {
    key := fmt.Sprintf("order_rate:%d", userID)
    now := time.Now().Unix()

    // ä½¿ç”¨Redis Sorted Setå®ç°æ»‘åŠ¨çª—å£
    // 1. ç§»é™¤1ç§’å‰çš„è®°å½•
    redis.ZRemRangeByScore(ctx, key, "0", fmt.Sprintf("%d", now-1))

    // 2. è·å–å½“å‰çª—å£å†…çš„æ•°é‡
    count := redis.ZCard(ctx, key).Val()

    if count >= 10 {
        return errors.New("order rate limit exceeded")
    }

    // 3. æ·»åŠ å½“å‰æ—¶é—´æˆ³
    redis.ZAdd(ctx, key, redis.Z{Score: float64(now), Member: uuid.New().String()})
    redis.Expire(ctx, key, 2*time.Second)

    return nil
}
```

**æ€§èƒ½å¯¹æ¯”:**

| å®ç°æ–¹å¼ | æŸ¥è¯¢å»¶è¿Ÿ | å¹¶å‘æ”¯æŒ | å­˜å‚¨å‹åŠ› |
|---------|---------|---------|---------|
| MySQLæŸ¥è¯¢ | 5-10ms | ä¸­ç­‰ | ä½ |
| Redisæ»‘åŠ¨çª—å£ | 0.5-1ms | æé«˜ | ä½ (è‡ªåŠ¨è¿‡æœŸ) |

---

### 2.5 è‡ªæˆäº¤æ£€æµ‹

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:186-188

func (rm *RiskManager) DetectSelfTrading(buyerID, sellerID uint) bool {
    return buyerID == sellerID
}
```

**è°ƒç”¨æ—¶æœº:**

```go
// go-backend/internal/services/order_service.go:78-84

// ä¿å­˜æˆäº¤è®°å½•å‰æ£€æµ‹
for _, trade := range trades {
    // [é£æ§æ£€æµ‹] è‡ªæˆäº¤æ£€æµ‹
    if s.riskManager != nil {
        isSelfTrading := s.riskManager.DetectSelfTrading(trade.BuyerID, trade.SellerID)
        if isSelfTrading {
            return errors.New("self-trading detected: buyer and seller are the same")
        }
    }

    // é€šè¿‡æ£€æµ‹åæ‰ä¿å­˜
    if err := tx.Create(trade).Error; err != nil {
        return err
    }
}
```

**æ£€æµ‹åœºæ™¯:**

```
åœºæ™¯1: æ­£å¸¸æˆäº¤
ç”¨æˆ·A (ID=1001) ä¸‹ä¹°å• â†’ ä¸ç”¨æˆ·B (ID=1002) çš„å–å•æˆäº¤
æ£€æµ‹: 1001 != 1002 âœ… å…è®¸

åœºæ™¯2: è‡ªæˆäº¤
ç”¨æˆ·A (ID=1001) ä¸‹ä¹°å• â†’ ä¸ç”¨æˆ·A (ID=1001) è‡ªå·±çš„å–å•æˆäº¤
æ£€æµ‹: 1001 == 1001 âŒ æ‹’ç»
é”™è¯¯: "self-trading detected: buyer and seller are the same"
å›æ»š: æ•´ä¸ªäº‹åŠ¡å›æ»š,è®¢å•çŠ¶æ€æ¢å¤
```

**æ”»å‡»åœºæ™¯åˆ†æ:**

```
æ”»å‡»æ‰‹æ³•: å¯¹æ•²äº¤æ˜“ (Wash Trading)

æ­¥éª¤:
1. ç”¨æˆ·Aåœ¨50,000 USDTæŒ‚å¤§é‡å–å•
2. ç”¨æˆ·AåŒæ—¶ä¸‹ä¹°å•,åƒæ‰è‡ªå·±çš„å–å•
3. ç›®çš„:
   - åˆ¶é€ è™šå‡äº¤æ˜“é‡,å¸å¼•æ•£æˆ·è·Ÿé£
   - æ“çºµä»·æ ¼,å½±å“å¸‚åœºæƒ…ç»ª
   - åˆ·äº¤æ˜“é‡è·å–å¹³å°å¥–åŠ±

é˜²æŠ¤æ•ˆæœ:
â”œâ”€â”€ æ’®åˆå¼•æ“åŒ¹é…åˆ°è‡ªå·±çš„è®¢å•
â”œâ”€â”€ ç”Ÿæˆæˆäº¤è®°å½•æ—¶æ£€æµ‹ buyerID == sellerID
â”œâ”€â”€ è§¦å‘ DetectSelfTrading() â†’ è¿”å› true
â”œâ”€â”€ æ•´ä¸ªäº‹åŠ¡å›æ»š
â””â”€â”€ è®¢å•æ¢å¤åˆ°å¾…æˆäº¤çŠ¶æ€
```

**å±€é™æ€§ä¸æ”¹è¿›:**

```
å½“å‰æ£€æµ‹èƒ½åŠ›:
âœ… å¯æ£€æµ‹: å•è´¦æˆ·è‡ªæˆäº¤
âŒ æ— æ³•æ£€æµ‹: å¤šè´¦æˆ·å¯¹æ•² (ç”¨æˆ·A â†â†’ ç”¨æˆ·B äº’ç›¸å¯¹æ•²)

æ”¹è¿›æ–¹æ¡ˆ:
1. IPå…³è”æ£€æµ‹: æ£€æµ‹åŒä¸€IPçš„å¤šä¸ªè´¦æˆ·äº’ç›¸äº¤æ˜“
2. è®¾å¤‡æŒ‡çº¹: æ£€æµ‹åŒä¸€è®¾å¤‡çš„å¤šä¸ªè´¦æˆ·
3. äº¤æ˜“æ¨¡å¼åˆ†æ: è¯†åˆ«é«˜åº¦åŒæ­¥çš„ä¹°å–è¡Œä¸º
```

---

## 3. æç°é£æ§ä½“ç³»

### 3.1 æç°é£æ§æµç¨‹å›¾

```
ç”¨æˆ·å‘èµ·æç°è¯·æ±‚
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WithdrawalService.CreateWithdrawal()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [1] è·å–ç”¨æˆ·ä¿¡æ¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥è¯¢ç”¨æˆ· KYC ç­‰çº§ã€è´¦æˆ·çŠ¶æ€                    â”‚
â”‚ â†’ user.KYCLevel: 0/1/2                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [2] é£æ§éªŒè¯å…¥å£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ riskManager.ValidateWithdrawal()               â”‚
â”‚ æ–‡ä»¶: security/risk_manager.go:113-150        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚               â”‚
        â–¼ [2.1]     â–¼ [2.2]     â–¼ [2.3]        â–¼ [2.4]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KYCç­‰çº§æ£€æŸ¥ â”‚ â”‚ æ¯æ—¥é™é¢ â”‚ â”‚é¦–æ¬¡åœ°å€æ£€â”‚ â”‚å¿«é€Ÿå……ææ£€æµ‹  â”‚
â”‚ Level 0?    â”‚ â”‚ è®¡ç®—     â”‚ â”‚æŸ¥        â”‚ â”‚(åæ´—é’±)      â”‚
â”‚ â†’ æ‹’ç»æç°  â”‚ â”‚          â”‚ â”‚          â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚               â”‚
        â–¼            â–¼            â–¼               â–¼
    é€šè¿‡KYC      è®¡ç®—ä»Šæ—¥      é¦–æ¬¡åœ°å€      å……ææ—¶é—´å·®
    ç­‰çº§æ£€æŸ¥    å·²æç°é‡‘é¢    éœ€è¦2FAç¡®è®¤   < 1å°æ—¶?
        â”‚            â”‚            â”‚               â”‚
        â–¼            â–¼            â–¼               â–¼
    Level 1/2    ç´¯è®¡æœªè¶…é™    éªŒè¯é€šè¿‡      é‡‘é¢ç›¸è¿‘?
    å¯æç°       å¯ç»§ç»­        å¯æç°        â†’ å¯ç–‘æ´—é’±
        â”‚            â”‚            â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ æ‰€æœ‰æ£€æŸ¥é€šè¿‡
                    åˆ›å»ºæç°è®°å½•
                    çŠ¶æ€: å¾…å®¡æ ¸
```

### 3.2 KYCç­‰çº§é™é¢ç³»ç»Ÿ

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:113-123

func (rm *RiskManager) ValidateWithdrawal(ctx context.Context, withdrawal *models.Withdrawal, user *models.User) error {
    // [æ£€æŸ¥1] KYCç­‰çº§éªŒè¯
    if user.KYCLevel == 0 {
        return errors.New("KYC verification required for withdrawal")
    }

    // [æ£€æŸ¥2] è·å–å¯¹åº”ç­‰çº§çš„æ¯æ—¥é™é¢
    limit, exists := rm.dailyWithdrawalLimit[user.KYCLevel]
    if !exists {
        limit = rm.dailyWithdrawalLimit[0]  // é»˜è®¤ä½¿ç”¨æœ€ä½é™é¢
    }

    // ... åç»­æ£€æŸ¥
}
```

**KYCç­‰çº§é…ç½®è¡¨:**

| KYCç­‰çº§ | è®¤è¯è¦æ±‚ | æ¯æ—¥é™é¢ (USDT) | å•ç¬”é™é¢ | é€‚ç”¨åœºæ™¯ |
|---------|---------|----------------|---------|---------|
| **0 - æœªè®¤è¯** | æ—  | 0 (ç¦æ­¢æç°) | N/A | æ–°æ³¨å†Œç”¨æˆ·/æœªå®åç”¨æˆ· |
| **1 - åˆçº§** | èº«ä»½è¯/æŠ¤ç…§ | 10,000 | 5,000 | æ™®é€šä¸ªäººç”¨æˆ· |
| **2 - é«˜çº§** | èº«ä»½è¯+åœ°å€è¯æ˜+äººè„¸è¯†åˆ« | 100,000 | 50,000 | VIPç”¨æˆ·/æœºæ„ç”¨æˆ· |

**æ•°æ®åº“è®¾è®¡:**

```sql
-- ç”¨æˆ·è¡¨ KYC ç›¸å…³å­—æ®µ
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    kyc_level INT DEFAULT 0 COMMENT '0:æœªè®¤è¯ 1:åˆçº§ 2:é«˜çº§',
    kyc_name VARCHAR(100),
    kyc_id_card VARCHAR(50),
    kyc_status VARCHAR(20) DEFAULT 'pending',
    kyc_verified_at DATETIME,
    -- ... å…¶ä»–å­—æ®µ
);

-- KYC è®¤è¯è®°å½•è¡¨
CREATE TABLE kyc_records (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    kyc_level INT NOT NULL,
    id_card VARCHAR(50),
    real_name VARCHAR(100),
    address VARCHAR(500),
    id_card_front_url VARCHAR(500),
    id_card_back_url VARCHAR(500),
    face_image_url VARCHAR(500),
    status VARCHAR(20) DEFAULT 'pending',  -- pending/approved/rejected
    reject_reason TEXT,
    submit_time DATETIME,
    å®¡æ ¸_time DATETIME,
    å®¡æ ¸_user_id BIGINT,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
);
```

**ç”¨æˆ·è¡Œä¸ºè§¦å‘åœºæ™¯:**

| åœºæ™¯ | ç”¨æˆ·KYCç­‰çº§ | æç°é‡‘é¢ | éªŒè¯ç»“æœ | é”™è¯¯ä¿¡æ¯ |
|------|------------|---------|---------|---------|
| æœªå®åæç° | 0 (æœªè®¤è¯) | ä»»æ„é‡‘é¢ | âŒ æ‹’ç» | "KYC verification required for withdrawal" |
| å°é¢æç° | 1 (åˆçº§) | 5,000 USDT | âœ… é€šè¿‡ | - |
| è¶…é™æç° | 1 (åˆçº§) | 15,000 USDT | âŒ æ‹’ç» | "daily withdrawal limit exceeded: 10000" |
| å¤§é¢æç° | 2 (é«˜çº§) | 50,000 USDT | âœ… é€šè¿‡ | - |
| è¶…å¤§é¢æç° | 2 (é«˜çº§) | 150,000 USDT | âŒ æ‹’ç» | "daily withdrawal limit exceeded: 100000" |

**æ¯æ—¥é™é¢è®¡ç®—é€»è¾‘:**

```go
// go-backend/internal/security/risk_manager.go:125-142

// [1] å®šä¹‰ä»Šæ—¥0ç‚¹æ—¶é—´æˆ³
today := time.Now().Truncate(24 * time.Hour)
var totalWithdrawn decimal.Decimal

// [2] æŸ¥è¯¢ä»Šæ—¥æ‰€æœ‰æç°è®°å½• (åŒ…æ‹¬å¾…å®¡æ ¸ã€å¤„ç†ä¸­ã€å·²å®Œæˆ)
var withdrawals []models.Withdrawal
database.DB.Where("user_id = ? AND create_time >= ? AND status IN ?",
    user.ID, today, []int{1, 2, 3}).Find(&withdrawals)

// [3] ç´¯åŠ è®¡ç®—ä»Šæ—¥å·²æç°é‡‘é¢
for _, w := range withdrawals {
    totalWithdrawn = totalWithdrawn.Add(w.Amount)
}

// [4] æ£€æŸ¥æ–°æç°æ˜¯å¦è¶…é™
if totalWithdrawn.Add(withdrawal.Amount).GreaterThan(limit) {
    return fmt.Errorf("daily withdrawal limit exceeded: %s", limit.String())
}
```

**è®¡ç®—ç¤ºä¾‹:**

```
åœºæ™¯: åˆçº§KYCç”¨æˆ· (æ¯æ—¥é™é¢10,000 USDT)

æ—¶é—´è½´:
09:00 - ç¬¬1ç¬”æç°: 3,000 USDT (çŠ¶æ€: å·²å®Œæˆ)
       ç´¯è®¡: 3,000 USDT
       éªŒè¯: 3,000 < 10,000 âœ… é€šè¿‡

12:00 - ç¬¬2ç¬”æç°: 4,000 USDT (çŠ¶æ€: å¤„ç†ä¸­)
       ç´¯è®¡: 3,000 + 4,000 = 7,000 USDT
       éªŒè¯: 7,000 < 10,000 âœ… é€šè¿‡

15:00 - ç¬¬3ç¬”æç°: 5,000 USDT
       ç´¯è®¡: 3,000 + 4,000 + 5,000 = 12,000 USDT
       éªŒè¯: 12,000 > 10,000 âŒ æ‹’ç»
       é”™è¯¯: "daily withdrawal limit exceeded: 10000"

æ¬¡æ—¥ 00:00:00 - é™é¢é‡ç½®
       ç´¯è®¡: 0 USDT (æ–°çš„ä¸€å¤©)
```

**çŠ¶æ€ç è¯´æ˜:**

```sql
-- æç°çŠ¶æ€æšä¸¾
status INT COMMENT
    '0:å¾…å®¡æ ¸
     1:å®¡æ ¸é€šè¿‡
     2:å¤„ç†ä¸­
     3:å·²å®Œæˆ
     4:æ‹’ç»'

-- è®¡å…¥æ¯æ—¥é™é¢çš„çŠ¶æ€: [1, 2, 3]
-- åŸå› :
--   1 (å®¡æ ¸é€šè¿‡): èµ„é‡‘å·²é”å®š,è™½æœªå‘å‡ºä½†å·²å ç”¨é™é¢
--   2 (å¤„ç†ä¸­): æ­£åœ¨é“¾ä¸Šå¤„ç†,èµ„é‡‘å·²ç¦»å¼€å¹³å°
--   3 (å·²å®Œæˆ): æç°å®Œæˆ,å¿…é¡»è®¡å…¥
--   4 (æ‹’ç»): ä¸è®¡å…¥,å› ä¸ºèµ„é‡‘æœªæµå‡º
--   0 (å¾…å®¡æ ¸): ä¸è®¡å…¥,å› ä¸ºå¯èƒ½è¢«æ‹’ç»
```

---

## 4. åæ´—é’±æ£€æµ‹æœºåˆ¶

### 4.1 å¿«é€Ÿå……ææ¨¡å¼æ£€æµ‹

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:168-181

// æ£€æµ‹å¿«é€Ÿå……å€¼-æç°æ¨¡å¼ (å¯èƒ½çš„æ´—é’±è¡Œä¸º)
oneHourAgo := time.Now().Add(-time.Hour)
var recentDeposit models.Deposit

if err := database.DB.Where("user_id = ? AND create_time > ? AND currency = ?",
    user.ID, oneHourAgo, withdrawal.Currency).
    First(&recentDeposit).Error; err == nil {

    // å‘ç°1å°æ—¶å†…æœ‰å……å€¼è®°å½•
    diff := recentDeposit.Amount.Sub(withdrawal.Amount).Abs()

    // æç°é‡‘é¢ä¸å……å€¼é‡‘é¢ç›¸å·® < 10%
    if diff.LessThan(recentDeposit.Amount.Mul(decimal.NewFromFloat(0.1))) {
        return errors.New("suspicious withdrawal pattern detected - manual review required")
    }
}
```

**æ£€æµ‹é€»è¾‘æµç¨‹:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¿«é€Ÿå……ææ£€æµ‹æµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·å‘èµ·æç°
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥è¯¢è¿‡å»1å°æ—¶å†…çš„å……å€¼è®°å½•             â”‚
â”‚ WHERE create_time > NOW() - 1 HOUR    â”‚
â”‚   AND currency = withdrawal.currency  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚                     â”‚
    â–¼             â–¼                     â–¼
æ— å……å€¼è®°å½•    æ‰¾åˆ°å……å€¼è®°å½•          å¤šç¬”å……å€¼
    â”‚             â”‚                     â”‚
    âœ… é€šè¿‡       â–¼                     â–¼
               è®¡ç®—é‡‘é¢å·®å¼‚         å–æœ€è¿‘ä¸€ç¬”
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ diff = |å……å€¼ - æç°|  â”‚
            â”‚ ratio = diff / å……å€¼   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼             â–¼            â–¼
                ratio > 10%   ratio â‰¤ 10%   ratio = 0%
                    â”‚             â”‚            â”‚
                    âœ… é€šè¿‡       âŒ å¯ç–‘      âŒ é«˜åº¦å¯ç–‘
                                  â”‚            â”‚
                          äººå·¥å®¡æ ¸é˜Ÿåˆ—    è‡ªåŠ¨æ ‡è®°+å†»ç»“
```

**æ´—é’±åœºæ™¯æ¨¡æ‹Ÿ:**

```
åœºæ™¯1: å…¸å‹æ´—é’±æ¨¡å¼ (å¿«é€Ÿå……æ)
10:00 - å……å€¼ 10,000 USDT (æ¥æº: å¯ç–‘åœ°å€)
10:30 - æç° 9,500 USDT (ç›®æ ‡: æ–°åœ°å€)

æ£€æµ‹ç»“æœ:
- æ—¶é—´å·®: 30åˆ†é’Ÿ < 1å°æ—¶ âœ… è§¦å‘æ£€æµ‹
- å……å€¼é‡‘é¢: 10,000 USDT
- æç°é‡‘é¢: 9,500 USDT
- å·®å¼‚: |10,000 - 9,500| = 500 USDT
- å·®å¼‚ç‡: 500 / 10,000 = 5%
- åˆ¤å®š: 5% < 10% âŒ å¯ç–‘
- é”™è¯¯: "suspicious withdrawal pattern detected - manual review required"

åœºæ™¯2: æ­£å¸¸äº¤æ˜“åæç°
08:00 - å……å€¼ 10,000 USDT
09:00-15:00 - è¿›è¡Œå¤šç¬”äº¤æ˜“,ç›ˆåˆ©2,000 USDT
16:00 - æç° 12,000 USDT

æ£€æµ‹ç»“æœ:
- æ—¶é—´å·®: 8å°æ—¶ > 1å°æ—¶ âœ… è·³è¿‡æ£€æµ‹ (æ—¶é—´çª—å£å¤–)

åœºæ™¯3: å……å€¼åéƒ¨åˆ†æç°
10:00 - å……å€¼ 10,000 USDT
10:40 - æç° 3,000 USDT

æ£€æµ‹ç»“æœ:
- æ—¶é—´å·®: 40åˆ†é’Ÿ < 1å°æ—¶ âœ… è§¦å‘æ£€æµ‹
- å·®å¼‚: |10,000 - 3,000| = 7,000 USDT
- å·®å¼‚ç‡: 7,000 / 10,000 = 70%
- åˆ¤å®š: 70% > 10% âœ… æ­£å¸¸ (éƒ¨åˆ†æç°)
```

**SQLæŸ¥è¯¢ä¼˜åŒ–:**

```sql
-- å®é™…æ‰§è¡Œçš„SQL
SELECT * FROM deposits
WHERE user_id = ?
  AND create_time > NOW() - INTERVAL 1 HOUR
  AND currency = ?
ORDER BY create_time DESC
LIMIT 1;

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_user_time_currency
ON deposits(user_id, create_time DESC, currency);
```

**è¯¯åˆ¤å¤„ç†:**

```
å¯èƒ½çš„æ­£å¸¸åœºæ™¯è¢«è¯¯åˆ¤:
1. ç”¨æˆ·å……å€¼åå‘ç°ä»·æ ¼ä¸åˆé€‚,ç«‹å³æç°
2. ç”¨æˆ·æµ‹è¯•å……æåŠŸèƒ½
3. ç”¨æˆ·åœ¨å¤šä¸ªå¹³å°å¥—åˆ© (æ¬ç –)

è§£å†³æ–¹æ¡ˆ:
â”œâ”€â”€ ä¸ç›´æ¥æ‹’ç»,è€Œæ˜¯æ ‡è®°ä¸º"éœ€è¦äººå·¥å®¡æ ¸"
â”œâ”€â”€ å…è®¸ç”¨æˆ·ç”³è¯‰å¹¶æä¾›è¯´æ˜
â”œâ”€â”€ å»ºç«‹ç™½åå•æœºåˆ¶ (é«˜ä¿¡ç”¨ç”¨æˆ·è·³è¿‡æ£€æµ‹)
â””â”€â”€ ç»“åˆå…¶ä»–ç»´åº¦ç»¼åˆåˆ¤æ–­ (IPã€è®¾å¤‡ã€å†å²è®°å½•)
```

---

### 4.2 é¦–æ¬¡æç°åœ°å€æ£€æµ‹

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:154-166

// æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡æç°åˆ°è¯¥åœ°å€
var count int64
database.DB.Model(&models.Withdrawal{}).
    Where("user_id = ? AND address = ? AND status = ?",
          user.ID, withdrawal.Address, 3).  // status=3: å·²å®Œæˆ
    Count(&count)

if count == 0 {
    // é¦–æ¬¡æç°åˆ°æ–°åœ°å€ - éœ€è¦é¢å¤–éªŒè¯
    // ç”Ÿäº§ç¯å¢ƒåº”å‘é€é‚®ä»¶/çŸ­ä¿¡ç¡®è®¤
    return errors.New("first time withdrawal to this address requires confirmation")
}
```

**æ£€æµ‹é€»è¾‘:**

```
æç°åœ°å€: 0x1234...5678
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥è¯¢å†å²æç°è®°å½•                     â”‚
â”‚ WHERE address = '0x1234...5678'      â”‚
â”‚   AND status = 3 (å·²å®Œæˆ)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚                â”‚
    â–¼              â–¼                â–¼
count = 0      count = 1       count > 1
é¦–æ¬¡æç°       ç¬¬2æ¬¡æç°        å¸¸ç”¨åœ°å€
    â”‚              â”‚                â”‚
    â–¼              â–¼                â–¼
âŒ éœ€è¦2FA    âœ… ç›´æ¥é€šè¿‡     âœ… ç›´æ¥é€šè¿‡
é‚®ä»¶ç¡®è®¤
çŸ­ä¿¡éªŒè¯
```

**å®‰å…¨ä»·å€¼:**

```
é˜²æŠ¤åœºæ™¯:
1. è´¦æˆ·è¢«ç›—å,é»‘å®¢å°è¯•æç°åˆ°è‡ªå·±åœ°å€
   â†’ è§¦å‘é¦–æ¬¡åœ°å€æ£€æµ‹
   â†’ å‘é€é‚®ä»¶/çŸ­ä¿¡åˆ°ç”¨æˆ·çœŸå®æ‰‹æœº
   â†’ ç”¨æˆ·å‘ç°å¼‚å¸¸åŠæ—¶é˜»æ­¢

2. ç”¨æˆ·æ‰‹æœº/ç”µè„‘ä¸­æœ¨é©¬,å¯†ç æ³„éœ²
   â†’ é»‘å®¢å°è¯•æç°
   â†’ éœ€è¦é€šè¿‡ç”¨æˆ·é‚®ç®±/æ‰‹æœºéªŒè¯
   â†’ å¤§å¤§å¢åŠ æ”»å‡»éš¾åº¦

3. å†…éƒ¨å‘˜å·¥ç›—ç”¨ç”¨æˆ·èµ„é‡‘
   â†’ æ— æ³•è·³è¿‡é¦–æ¬¡åœ°å€éªŒè¯
   â†’ æç°è®°å½•å¯è¿½æº¯
```

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–:**

```
é¦–æ¬¡æç°æµç¨‹:
1. ç”¨æˆ·è¾“å…¥æ–°åœ°å€,æäº¤æç°
2. ç³»ç»Ÿæ£€æµ‹åˆ°é¦–æ¬¡åœ°å€
3. å‘é€éªŒè¯ç åˆ°é‚®ç®±/æ‰‹æœº
4. ç”¨æˆ·è¾“å…¥éªŒè¯ç 
5. éªŒè¯é€šè¿‡,æç°è¿›å…¥å®¡æ ¸é˜Ÿåˆ—
6. è¯¥åœ°å€è¢«åŠ å…¥ç™½åå•

åç»­æç°:
1. ç”¨æˆ·å†æ¬¡æç°åˆ°è¯¥åœ°å€
2. ç³»ç»Ÿæ£€æµ‹åˆ°å†å²è®°å½• (count > 0)
3. è·³è¿‡é¢å¤–éªŒè¯,ç›´æ¥å¤„ç†
```

**æ•°æ®åº“è®¾è®¡:**

```sql
-- æç°è¡¨
CREATE TABLE withdrawals (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    currency VARCHAR(20) NOT NULL,
    amount DECIMAL(36, 18) NOT NULL,
    address VARCHAR(200) NOT NULL,  -- æç°åœ°å€
    status INT DEFAULT 0,
    txid VARCHAR(200),
    create_time DATETIME,
    complete_time DATETIME,

    -- é¦–æ¬¡åœ°å€éªŒè¯ç›¸å…³
    is_new_address BOOLEAN DEFAULT FALSE,
    verification_code VARCHAR(6),
    verification_time DATETIME,

    INDEX idx_user_address (user_id, address),
    INDEX idx_status (status)
);

-- ç™½åå•åœ°å€è¡¨ (ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½)
CREATE TABLE withdrawal_address_whitelist (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    currency VARCHAR(20) NOT NULL,
    address VARCHAR(200) NOT NULL,
    first_use_time DATETIME,
    last_use_time DATETIME,
    total_withdrawals INT DEFAULT 0,
    total_amount DECIMAL(36, 18) DEFAULT 0,
    is_verified BOOLEAN DEFAULT TRUE,

    UNIQUE KEY uk_user_address (user_id, currency, address),
    INDEX idx_user_id (user_id)
);
```

---

## 5. é£é™©è¯„åˆ†ç³»ç»Ÿ

### 5.1 ç»¼åˆé£é™©è¯„åˆ†æ¨¡å‹

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:213-267

func (rm *RiskManager) CalculateRiskScore(ctx context.Context, userID uint) (float64, error) {
    var score float64

    // å› å­1: äº¤æ˜“é¢‘ç‡ (æƒé‡20%)
    thirtyDaysAgo := time.Now().Add(-30 * 24 * time.Hour)
    var orderCount int64
    database.DB.Model(&models.Order{}).
        Where("user_id = ? AND create_time > ?", userID, thirtyDaysAgo).
        Count(&orderCount)

    if orderCount > 1000 {
        score += 20  // è¶…é«˜é¢‘äº¤æ˜“
    } else if orderCount > 100 {
        score += 10  // é«˜é¢‘äº¤æ˜“
    } else {
        score += 5   // æ­£å¸¸/ä½é¢‘äº¤æ˜“
    }

    // å› å­2: å¤§é¢äº¤æ˜“ (æƒé‡30%)
    var orders []models.Order
    database.DB.Where("user_id = ? AND create_time > ?", userID, thirtyDaysAgo).
        Order("filled_amount DESC").
        Limit(10).
        Find(&orders)

    var totalAmount decimal.Decimal
    for _, order := range orders {
        totalAmount = totalAmount.Add(order.FilledAmount)
    }

    avgAmount, _ := totalAmount.Div(decimal.NewFromInt(int64(len(orders)))).Float64()
    if avgAmount > 100000 {
        score += 30  // å·¨é¢äº¤æ˜“
    } else if avgAmount > 10000 {
        score += 20  // å¤§é¢äº¤æ˜“
    } else {
        score += 10  // æ­£å¸¸äº¤æ˜“
    }

    // å› å­3: å…³è”è´¦æˆ· (æƒé‡20%)
    relatedAccounts, _ := rm.DetectRelatedAccounts(ctx, userID)
    if len(relatedAccounts) > 5 {
        score += 20  // å¤šè´¦æˆ·å…³è”
    } else if len(relatedAccounts) > 0 {
        score += 10  // å°‘é‡å…³è”
    }

    // å› å­4: åœ°ç†é£é™© (æƒé‡15%) - TODO
    // å› å­5: å†å²è¿è§„ (æƒé‡15%) - TODO

    return score, nil
}
```

**è¯„åˆ†ç»´åº¦è¯¦è§£:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é£é™©è¯„åˆ†ç³»ç»Ÿ (æ€»åˆ†100åˆ†)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å› å­1: äº¤æ˜“é¢‘ç‡ (20åˆ†)
â”œâ”€â”€ è¶…é«˜é¢‘ (>1000ç¬”/30å¤©): 20åˆ† â†’ å¯èƒ½æ˜¯æœºå™¨äºº/åˆ·å•
â”œâ”€â”€ é«˜é¢‘ (100-1000ç¬”):     10åˆ† â†’ æ´»è·ƒäº¤æ˜“è€…
â””â”€â”€ æ­£å¸¸ (<100ç¬”):          5åˆ† â†’ æ™®é€šç”¨æˆ·

å› å­2: äº¤æ˜“é‡‘é¢ (30åˆ†)
â”œâ”€â”€ å·¨é¢ (å¹³å‡>10ä¸‡USDT):  30åˆ† â†’ å¤§æˆ·/æœºæ„
â”œâ”€â”€ å¤§é¢ (å¹³å‡1ä¸‡-10ä¸‡):   20åˆ† â†’ VIPç”¨æˆ·
â””â”€â”€ æ­£å¸¸ (å¹³å‡<1ä¸‡):       10åˆ† â†’ æ•£æˆ·

å› å­3: å…³è”è´¦æˆ· (20åˆ†)
â”œâ”€â”€ å¤šè´¦æˆ· (>5ä¸ª):        20åˆ† â†’ å¯èƒ½åˆ·å•/æ´—é’±
â”œâ”€â”€ å°‘é‡å…³è” (1-5ä¸ª):     10åˆ† â†’ æ­£å¸¸å…³è”(å®¶äºº/æœ‹å‹)
â””â”€â”€ æ— å…³è”:                0åˆ† â†’ ç‹¬ç«‹è´¦æˆ·

å› å­4: åœ°ç†é£é™© (15åˆ†) - å¾…å®ç°
â”œâ”€â”€ é«˜é£é™©å›½å®¶/åœ°åŒº:      15åˆ†
â”œâ”€â”€ ä¸­ç­‰é£é™©:             8åˆ†
â””â”€â”€ ä½é£é™©:               3åˆ†

å› å­5: å†å²è¿è§„ (15åˆ†) - å¾…å®ç°
â”œâ”€â”€ å¤šæ¬¡è¿è§„:            15åˆ†
â”œâ”€â”€ ä¸€æ¬¡è¿è§„:             8åˆ†
â””â”€â”€ æ— è¿è§„:               0åˆ†

æ€»åˆ†è§£è¯»:
â”œâ”€â”€ 0-30åˆ†:   ä½é£é™© â†’ æ­£å¸¸äº¤æ˜“æƒé™
â”œâ”€â”€ 31-60åˆ†:  ä¸­é£é™© â†’ åŠ å¼ºç›‘æ§,é™åˆ¶éƒ¨åˆ†åŠŸèƒ½
â”œâ”€â”€ 61-80åˆ†:  é«˜é£é™© â†’ ä¸¥æ ¼ç›‘æ§,å¤§é¢éœ€å®¡æ ¸
â””â”€â”€ 81-100åˆ†: æé«˜é£é™© â†’ å†»ç»“è´¦æˆ·,äººå·¥å®¡æ ¸
```

**è¯„åˆ†ç¤ºä¾‹:**

```
ç”¨æˆ·A: æ™®é€šæ•£æˆ·
- 30å¤©è®¢å•æ•°: 50ç¬” â†’ 5åˆ†
- å¹³å‡äº¤æ˜“é¢: 5,000 USDT â†’ 10åˆ†
- å…³è”è´¦æˆ·: 0ä¸ª â†’ 0åˆ†
- æ€»åˆ†: 15åˆ† âœ… ä½é£é™©

ç”¨æˆ·B: æ´»è·ƒäº¤æ˜“è€…
- 30å¤©è®¢å•æ•°: 500ç¬” â†’ 10åˆ†
- å¹³å‡äº¤æ˜“é¢: 50,000 USDT â†’ 20åˆ†
- å…³è”è´¦æˆ·: 1ä¸ª (é…å¶è´¦æˆ·) â†’ 10åˆ†
- æ€»åˆ†: 40åˆ† âš ï¸ ä¸­é£é™©

ç”¨æˆ·C: å¯ç–‘è´¦æˆ·
- 30å¤©è®¢å•æ•°: 2000ç¬” â†’ 20åˆ†
- å¹³å‡äº¤æ˜“é¢: 200,000 USDT â†’ 30åˆ†
- å…³è”è´¦æˆ·: 10ä¸ª (åŒä¸€IP) â†’ 20åˆ†
- æ€»åˆ†: 70åˆ† âŒ é«˜é£é™©
```

**é£æ§æªæ–½æ˜ å°„è¡¨:**

| é£é™©åˆ†æ•° | é£é™©ç­‰çº§ | è‡ªåŠ¨æªæ–½ | äº¤æ˜“é™åˆ¶ | æç°é™åˆ¶ |
|---------|---------|---------|---------|---------|
| 0-30 | ä½é£é™© | æ—  | æ— é™åˆ¶ | æ­£å¸¸é¢åº¦ |
| 31-60 | ä¸­é£é™© | åŠ å¼ºç›‘æ§ | å•ç¬”é™åˆ¶50ä¸‡ | éœ€è¦2FA |
| 61-80 | é«˜é£é™© | å®æ—¶å‘Šè­¦ | å•ç¬”é™åˆ¶10ä¸‡ | äººå·¥å®¡æ ¸ |
| 81-100 | æé«˜é£é™© | è‡ªåŠ¨å†»ç»“ | ç¦æ­¢äº¤æ˜“ | ç¦æ­¢æç° |

---

### 5.2 å…³è”è´¦æˆ·æ£€æµ‹

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:191-210

func (rm *RiskManager) DetectRelatedAccounts(ctx context.Context, userID uint) ([]uint, error) {
    // [1] è·å–ç›®æ ‡ç”¨æˆ·çš„IPä¿¡æ¯
    var user models.User
    if err := database.DB.First(&user, userID).Error; err != nil {
        return nil, err
    }

    // [2] æŸ¥æ‰¾å…±äº«IPçš„å…¶ä»–è´¦æˆ·
    var relatedUsers []models.User
    if err := database.DB.Where("id != ? AND (register_ip = ? OR last_login_ip = ?)",
        userID, user.RegisterIP, user.LastLoginIP).
        Find(&relatedUsers).Error; err != nil {
        return nil, err
    }

    // [3] æå–å…³è”è´¦æˆ·IDåˆ—è¡¨
    relatedIDs := make([]uint, len(relatedUsers))
    for i, u := range relatedUsers {
        relatedIDs[i] = u.ID
    }

    return relatedIDs, nil
}
```

**æ£€æµ‹ç»´åº¦:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å…³è”è´¦æˆ·æ£€æµ‹ç»´åº¦                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»´åº¦1: æ³¨å†ŒIP (register_ip)
ç”¨æˆ·Aæ³¨å†ŒIP: 192.168.1.100
ç”¨æˆ·Bæ³¨å†ŒIP: 192.168.1.100
â†’ åˆ¤å®š: å¯èƒ½æ˜¯åŒä¸€äºº/åŒä¸€å®¶åº­/åŒä¸€å…¬å¸

ç»´åº¦2: ç™»å½•IP (last_login_ip)
ç”¨æˆ·Aæœ€è¿‘ç™»å½•IP: 10.0.0.50
ç”¨æˆ·Bæœ€è¿‘ç™»å½•IP: 10.0.0.50
â†’ åˆ¤å®š: å¯èƒ½å…±äº«è®¾å¤‡/ç½‘ç»œ

ç»¼åˆåˆ¤å®š:
WHERE (register_ip = ? OR last_login_ip = ?)
â†’ åªè¦æ³¨å†ŒIPæˆ–ç™»å½•IPä»»ä¸€åŒ¹é…,å³åˆ¤å®šä¸ºå…³è”
```

**æ£€æµ‹ç»“æœç¤ºä¾‹:**

```
åœºæ™¯1: å®¶åº­ç”¨æˆ· (åˆæ³•å…³è”)
ç”¨æˆ·A (çˆ¶äº²): æ³¨å†ŒIP=192.168.1.100, ç™»å½•IP=192.168.1.100
ç”¨æˆ·B (æ¯äº²): æ³¨å†ŒIP=192.168.1.100, ç™»å½•IP=192.168.1.100
ç”¨æˆ·C (å„¿å­): æ³¨å†ŒIP=192.168.1.100, ç™»å½•IP=192.168.1.100

æ£€æµ‹ç»“æœ:
- ç”¨æˆ·Aå…³è”è´¦æˆ·: [B, C] (2ä¸ª)
- è¯„åˆ†å½±å“: +10åˆ† (å°‘é‡å…³è”)
- é£æ§æªæ–½: æ­£å¸¸,ä¸é™åˆ¶

åœºæ™¯2: åˆ·å•å·¥ä½œå®¤ (æ¶æ„å…³è”)
ç”¨æˆ·1-20: å…¨éƒ¨æ³¨å†ŒIP=203.0.113.50 (åŒä¸€å…¬ç½‘IP)
          å…¨éƒ¨ç™»å½•IP=203.0.113.50

æ£€æµ‹ç»“æœ:
- æ¯ä¸ªç”¨æˆ·å…³è”è´¦æˆ·: 19ä¸ª
- è¯„åˆ†å½±å“: +20åˆ† (å¤šè´¦æˆ·å…³è”)
- é£æ§æªæ–½: æ ‡è®°ä¸ºé«˜é£é™©,é™åˆ¶äº¤æ˜“

åœºæ™¯3: å…¬å¸ç½‘ç»œ (è¯¯åˆ¤)
å…¬å¸å‘˜å·¥A-50: å…¨éƒ¨é€šè¿‡å…¬å¸NATå‡ºå£IP=198.51.100.1

æ£€æµ‹ç»“æœ:
- æ¯ä¸ªç”¨æˆ·å…³è”è´¦æˆ·: 49ä¸ª
- è¯„åˆ†å½±å“: +20åˆ†
- å¤„ç†: éœ€è¦äººå·¥å®¡æ ¸,å»ºç«‹ç™½åå•
```

**æ•°æ®åº“è®¾è®¡:**

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,

    -- IPè¿½è¸ªå­—æ®µ
    register_ip VARCHAR(45) NOT NULL,      -- æ³¨å†Œæ—¶çš„IP (æ”¯æŒIPv6)
    last_login_ip VARCHAR(45),             -- æœ€åç™»å½•IP
    last_login_time DATETIME,              -- æœ€åç™»å½•æ—¶é—´

    -- è®¾å¤‡æŒ‡çº¹ (å¯æ‰©å±•)
    register_device_id VARCHAR(100),       -- æ³¨å†Œè®¾å¤‡æŒ‡çº¹
    last_device_id VARCHAR(100),           -- æœ€åä½¿ç”¨è®¾å¤‡æŒ‡çº¹

    -- åœ°ç†ä½ç½® (å¯æ‰©å±•)
    register_country VARCHAR(50),          -- æ³¨å†Œå›½å®¶
    register_city VARCHAR(100),            -- æ³¨å†ŒåŸå¸‚

    INDEX idx_register_ip (register_ip),
    INDEX idx_last_login_ip (last_login_ip),
    INDEX idx_device (register_device_id, last_device_id)
);

-- IPç™»å½•å†å²è¡¨ (è¯¦ç»†è¿½è¸ª)
CREATE TABLE login_history (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    ip VARCHAR(45) NOT NULL,
    device_id VARCHAR(100),
    user_agent VARCHAR(500),
    country VARCHAR(50),
    city VARCHAR(100),
    login_time DATETIME NOT NULL,
    login_result VARCHAR(20),  -- success/failed/blocked

    INDEX idx_user_time (user_id, login_time DESC),
    INDEX idx_ip (ip)
);
```

**é«˜çº§æ£€æµ‹ç­–ç•¥ (å¾…å®ç°):**

```
1. è®¾å¤‡æŒ‡çº¹åŒ¹é…
â”œâ”€â”€ æµè§ˆå™¨æŒ‡çº¹ (Canvas/WebGLæŒ‡çº¹)
â”œâ”€â”€ ç¡¬ä»¶æŒ‡çº¹ (MACåœ°å€/ç¡¬ç›˜åºåˆ—å·)
â””â”€â”€ è¡Œä¸ºæŒ‡çº¹ (é¼ æ ‡ç§»åŠ¨/é”®ç›˜æ•²å‡»èŠ‚å¥)

2. è¡Œä¸ºæ¨¡å¼åˆ†æ
â”œâ”€â”€ ç™»å½•æ—¶é—´ç›¸ä¼¼åº¦
â”œâ”€â”€ äº¤æ˜“ä¹ æƒ¯ç›¸ä¼¼åº¦ (äº¤æ˜“å¯¹/é‡‘é¢/é¢‘ç‡)
â””â”€â”€ èµ„é‡‘æµå‘åˆ†æ (è´¦æˆ·é—´é¢‘ç¹è½¬è´¦)

3. ç¤¾äº¤ç½‘ç»œåˆ†æ
â”œâ”€â”€ æ„å»ºè´¦æˆ·å…³ç³»å›¾è°±
â”œâ”€â”€ è¯†åˆ«é›†å›¢åŒ–ä½œå¼Š
â””â”€â”€ å‘ç°éšè”½çš„å…³è”å…³ç³»
```

---

## 6. è´¦æˆ·è¡Œä¸ºç›‘æ§

### 6.1 è´¦æˆ·å†»ç»“ä¸è§£å†»

**æ ¸å¿ƒä»£ç :**

```go
// go-backend/internal/security/risk_manager.go:269-281

// å†»ç»“è´¦æˆ·
func (rm *RiskManager) FreezeAccount(ctx context.Context, userID uint, reason string) error {
    return database.DB.Model(&models.User{}).
        Where("id = ?", userID).
        Update("status", 2).Error  // status=2: å†»ç»“çŠ¶æ€
}

// è§£å†»è´¦æˆ·
func (rm *RiskManager) UnfreezeAccount(ctx context.Context, userID uint) error {
    return database.DB.Model(&models.User{}).
        Where("id = ?", userID).
        Update("status", 1).Error  // status=1: æ­£å¸¸çŠ¶æ€
}
```

**è´¦æˆ·çŠ¶æ€å®šä¹‰:**

```sql
-- ç”¨æˆ·è¡¨çŠ¶æ€å­—æ®µ
status INT DEFAULT 1 COMMENT
    '1: æ­£å¸¸ (active)
     2: å†»ç»“ (frozen)
     3: ç¦ç”¨ (disabled)
     4: æ³¨é”€ (deleted)'
```

**çŠ¶æ€è½¬æ¢å›¾:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è´¦æˆ·çŠ¶æ€è½¬æ¢æµç¨‹                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    [æ–°æ³¨å†Œ]
        â”‚
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1:æ­£å¸¸  â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
        â”‚                     â”‚
        â”‚ è§¦å‘é£æ§è§„åˆ™        â”‚ å®¡æ ¸é€šè¿‡/ç”³è¯‰æˆåŠŸ
        â”‚ (é£é™©åˆ†>80)        â”‚
        â–¼                     â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           [äººå·¥å®¡æ ¸]
   â”‚ 2:å†»ç»“  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ é•¿æœŸæœªè§£å†³/ä¸¥é‡è¿è§„
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 3:ç¦ç”¨  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ ç”¨æˆ·ä¸»åŠ¨ç”³è¯·
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 4:æ³¨é”€  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è‡ªåŠ¨å†»ç»“è§¦å‘æ¡ä»¶:**

```
è§¦å‘æ¡ä»¶1: é£é™©è¯„åˆ† > 80
â”œâ”€â”€ è®¡ç®—ç”¨æˆ·é£é™©è¯„åˆ†
â”œâ”€â”€ score > 80 â†’ è‡ªåŠ¨å†»ç»“
â”œâ”€â”€ å‘é€å‘Šè­¦é‚®ä»¶/çŸ­ä¿¡
â””â”€â”€ è¿›å…¥äººå·¥å®¡æ ¸é˜Ÿåˆ—

è§¦å‘æ¡ä»¶2: æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º
â”œâ”€â”€ çŸ­æ—¶é—´å†…å¤§é‡æç°å¤±è´¥ (å¯èƒ½è¢«ç›—å·)
â”œâ”€â”€ ç™»å½•IPçªç„¶å˜æ›´åˆ°é«˜é£é™©å›½å®¶
â”œâ”€â”€ è¿ç»­å¤šæ¬¡è¾“å…¥é”™è¯¯å¯†ç 
â””â”€â”€ è‡ªåŠ¨å†»ç»“ + å‘é€éªŒè¯ç 

è§¦å‘æ¡ä»¶3: äººå·¥æ ‡è®°
â”œâ”€â”€ å®¢æœæ”¶åˆ°ä¸¾æŠ¥
â”œâ”€â”€ å®¡è®¡å‘ç°è¿è§„
â””â”€â”€ åˆè§„è¦æ±‚ (æ³•é™¢/ç›‘ç®¡å†»ç»“)
```

**å†»ç»“åçš„åŠŸèƒ½é™åˆ¶:**

```go
// åœ¨æ‰€æœ‰å…³é”®æ“ä½œå‰æ£€æŸ¥è´¦æˆ·çŠ¶æ€
func (s *OrderService) CreateOrder(order *models.Order) error {
    var user models.User
    database.DB.First(&user, order.UserID)

    // æ£€æŸ¥è´¦æˆ·çŠ¶æ€
    if user.Status != 1 {
        switch user.Status {
        case 2:
            return errors.New("account is frozen - contact support")
        case 3:
            return errors.New("account is disabled")
        case 4:
            return errors.New("account is deleted")
        }
    }

    // ç»§ç»­å¤„ç†è®¢å•
    // ...
}
```

| åŠŸèƒ½ | æ­£å¸¸ (1) | å†»ç»“ (2) | ç¦ç”¨ (3) | æ³¨é”€ (4) |
|------|---------|---------|---------|---------|
| ç™»å½• | âœ… å…è®¸ | âœ… å…è®¸ | âŒ æ‹’ç» | âŒ æ‹’ç» |
| æŸ¥çœ‹ä½™é¢ | âœ… å…è®¸ | âœ… å…è®¸ | âŒ æ‹’ç» | âŒ æ‹’ç» |
| ä¸‹å•äº¤æ˜“ | âœ… å…è®¸ | âŒ æ‹’ç» | âŒ æ‹’ç» | âŒ æ‹’ç» |
| å……å€¼ | âœ… å…è®¸ | âŒ æ‹’ç» | âŒ æ‹’ç» | âŒ æ‹’ç» |
| æç° | âœ… å…è®¸ | âŒ æ‹’ç» | âŒ æ‹’ç» | âŒ æ‹’ç» |
| ç”³è¯‰ | - | âœ… å…è®¸ | âœ… å…è®¸ | âŒ æ‹’ç» |

---

## 7. æ•°æ®åº“è®¾è®¡ä¸ç´¢å¼•

### 7.1 é£æ§ç›¸å…³æ•°æ®è¡¨

**å®¡è®¡æ—¥å¿—è¡¨:**

```sql
-- deployment/init_mysql.sql

CREATE TABLE audit_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED,
    action VARCHAR(50) NOT NULL,           -- æ“ä½œç±»å‹: login/order/withdrawal/etc
    resource_type VARCHAR(50),             -- èµ„æºç±»å‹: order/withdrawal/user
    resource_id VARCHAR(100),              -- èµ„æºID
    ip_address VARCHAR(45),                -- æ“ä½œIP
    user_agent VARCHAR(500),               -- æµè§ˆå™¨ä¿¡æ¯
    request_data TEXT,                     -- è¯·æ±‚æ•°æ® (JSON)
    response_data TEXT,                    -- å“åº”æ•°æ® (JSON)
    status VARCHAR(20),                    -- æ“ä½œç»“æœ: success/failed/blocked
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_create_time (create_time DESC),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**é£é™©äº‹ä»¶è¡¨:**

```sql
CREATE TABLE risk_events (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    event_type VARCHAR(50) NOT NULL COMMENT 'order_validation/withdrawal_validation/rate_limit_exceeded/etc',
    severity VARCHAR(20) NOT NULL COMMENT 'low/medium/high/critical',
    description VARCHAR(500) NOT NULL,
    details TEXT,                          -- JSONè¯¦ç»†æ•°æ®
    action VARCHAR(20) NOT NULL COMMENT 'allowed/blocked/flagged/frozen',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_event_type (event_type),
    INDEX idx_severity (severity),
    INDEX idx_create_time (create_time DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**é»‘åå•è¡¨:**

```sql
CREATE TABLE blacklist (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    type VARCHAR(20) NOT NULL COMMENT 'ip/address/user/device',
    value VARCHAR(500) NOT NULL,           -- é»‘åå•å€¼
    reason VARCHAR(500),                   -- åŠ å…¥åŸå› 
    severity VARCHAR(20) DEFAULT 'medium', -- ä¸¥é‡ç¨‹åº¦
    is_active BOOLEAN DEFAULT TRUE,        -- æ˜¯å¦ç”Ÿæ•ˆ
    expire_time DATETIME,                  -- è¿‡æœŸæ—¶é—´ (NULLè¡¨ç¤ºæ°¸ä¹…)
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    create_user_id BIGINT UNSIGNED,

    INDEX idx_type_value (type, value),
    INDEX idx_is_active (is_active),
    INDEX idx_expire_time (expire_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**é€Ÿç‡é™åˆ¶è¡¨:**

```sql
CREATE TABLE rate_limits (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED,
    ip_address VARCHAR(45),
    action VARCHAR(50) NOT NULL,           -- é™åˆ¶çš„æ“ä½œ: order/withdrawal/login
    count INT DEFAULT 0,                   -- è®¡æ•°
    window_start DATETIME NOT NULL,        -- æ—¶é—´çª—å£å¼€å§‹
    window_end DATETIME NOT NULL,          -- æ—¶é—´çª—å£ç»“æŸ
    is_blocked BOOLEAN DEFAULT FALSE,      -- æ˜¯å¦å·²è¢«é˜»æ­¢

    INDEX idx_user_action (user_id, action),
    INDEX idx_ip_action (ip_address, action),
    INDEX idx_window_end (window_end)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 7.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–:**

```sql
-- ä¼˜åŒ–1: è®¢å•é¢‘ç‡æŸ¥è¯¢
-- æŸ¥è¯¢: æœ€è¿‘1ç§’å†…ç”¨æˆ·è®¢å•æ•°
EXPLAIN SELECT COUNT(*) FROM orders
WHERE user_id = 1001 AND create_time > NOW() - INTERVAL 1 SECOND;

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_user_create_time ON orders(user_id, create_time DESC);
-- æ•ˆæœ: æŸ¥è¯¢æ—¶é—´ä» 50ms é™ä½åˆ° 2ms

-- ä¼˜åŒ–2: æç°é™é¢æŸ¥è¯¢
-- æŸ¥è¯¢: ä»Šæ—¥å·²æç°é‡‘é¢
EXPLAIN SELECT SUM(amount) FROM withdrawals
WHERE user_id = 1001
  AND create_time >= CURDATE()
  AND status IN (1, 2, 3);

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_user_time_status ON withdrawals(user_id, create_time, status);
-- æ•ˆæœ: æŸ¥è¯¢æ—¶é—´ä» 30ms é™ä½åˆ° 1ms

-- ä¼˜åŒ–3: å…³è”è´¦æˆ·æŸ¥è¯¢
-- æŸ¥è¯¢: å…±äº«IPçš„è´¦æˆ·
EXPLAIN SELECT id FROM users
WHERE register_ip = '192.168.1.100' OR last_login_ip = '192.168.1.100';

-- ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_register_ip ON users(register_ip);
CREATE INDEX idx_last_login_ip ON users(last_login_ip);
-- æ•ˆæœ: æŸ¥è¯¢æ—¶é—´ä» 100ms é™ä½åˆ° 5ms
```

---

## 8. å®æ—¶ç›‘æ§ä¸å‘Šè­¦

### 8.1 é£æ§æŒ‡æ ‡ç›‘æ§

**å…³é”®æŒ‡æ ‡åˆ—è¡¨:**

```
ä¸šåŠ¡æŒ‡æ ‡:
â”œâ”€â”€ è®¢å•æ‹’ç»ç‡ = è¢«é£æ§æ‹’ç»çš„è®¢å•æ•° / æ€»è®¢å•æ•°
â”‚   å‘Šè­¦é˜ˆå€¼: >10% (å¯èƒ½æ˜¯é£æ§è§„åˆ™è¿‡ä¸¥)
â”‚
â”œâ”€â”€ æç°å®¡æ ¸ç‡ = éœ€äººå·¥å®¡æ ¸çš„æç°æ•° / æ€»æç°æ•°
â”‚   å‘Šè­¦é˜ˆå€¼: >30% (å¯èƒ½æ˜¯æ´—é’±æ£€æµ‹è¿‡äºæ•æ„Ÿ)
â”‚
â”œâ”€â”€ è´¦æˆ·å†»ç»“ç‡ = å†»ç»“è´¦æˆ·æ•° / æ€»æ´»è·ƒè´¦æˆ·æ•°
â”‚   å‘Šè­¦é˜ˆå€¼: >5% (å¯èƒ½æ˜¯æ‰¹é‡æ”»å‡»)
â”‚
â””â”€â”€ å¹³å‡é£é™©è¯„åˆ† = æ‰€æœ‰ç”¨æˆ·é£é™©è¯„åˆ†çš„å¹³å‡å€¼
    å‘Šè­¦é˜ˆå€¼: >50åˆ† (ç”¨æˆ·æ•´ä½“é£é™©ä¸Šå‡)

æŠ€æœ¯æŒ‡æ ‡:
â”œâ”€â”€ é£æ§APIå“åº”æ—¶é—´ = ValidateOrder/ValidateWithdrawalè€—æ—¶
â”‚   å‘Šè­¦é˜ˆå€¼: >100ms (å½±å“ç”¨æˆ·ä½“éªŒ)
â”‚
â”œâ”€â”€ æ•°æ®åº“æŸ¥è¯¢è€—æ—¶ = é£æ§ç›¸å…³SQLå¹³å‡è€—æ—¶
â”‚   å‘Šè­¦é˜ˆå€¼: >50ms (éœ€è¦ä¼˜åŒ–ç´¢å¼•)
â”‚
â””â”€â”€ é£æ§è§„åˆ™æ‰§è¡ŒæˆåŠŸç‡ = æˆåŠŸæ‰§è¡Œæ¬¡æ•° / æ€»è°ƒç”¨æ¬¡æ•°
    å‘Šè­¦é˜ˆå€¼: <99.9% (é£æ§ç³»ç»Ÿä¸ç¨³å®š)

å®‰å…¨æŒ‡æ ‡:
â”œâ”€â”€ å¼‚å¸¸ç™»å½•æ¬¡æ•° = IPçªå˜/è®¾å¤‡çªå˜çš„ç™»å½•æ•°
â”‚   å‘Šè­¦é˜ˆå€¼: >100æ¬¡/å°æ—¶ (å¯èƒ½æ˜¯æ’åº“æ”»å‡»)
â”‚
â”œâ”€â”€ å¯ç–‘æç°æ•°é‡ = è§¦å‘åæ´—é’±æ£€æµ‹çš„æç°æ•°
â”‚   å‘Šè­¦é˜ˆå€¼: >50ç¬”/å¤© (å¼‚å¸¸æ´»åŠ¨)
â”‚
â””â”€â”€ é»‘åå•å‘½ä¸­æ¬¡æ•° = è¢«é»‘åå•æ‹¦æˆªçš„è¯·æ±‚æ•°
    å‘Šè­¦é˜ˆå€¼: >1000æ¬¡/å°æ—¶ (å¤§è§„æ¨¡æ”»å‡»)
```

### 8.2 å‘Šè­¦è§„åˆ™é…ç½®

**å‘Šè­¦çº§åˆ«å®šä¹‰:**

```yaml
# å‘Šè­¦é…ç½®ç¤ºä¾‹ (YAMLæ ¼å¼)
alerts:
  # P0 - ä¸¥é‡å‘Šè­¦ (ç«‹å³å¤„ç†)
  - name: å¤§è§„æ¨¡è´¦æˆ·å†»ç»“
    condition: freeze_account_count > 100 in 10m
    severity: critical
    notification:
      - type: phone
        contacts: [security_team_oncall]
      - type: dingtalk
        webhook: https://...

  # P1 - é«˜ä¼˜å…ˆçº§å‘Šè­¦
  - name: é£æ§APIå¼‚å¸¸
    condition: risk_api_error_rate > 5% in 5m
    severity: high
    notification:
      - type: email
        contacts: [dev_team@example.com]
      - type: slack
        channel: #alerts

  # P2 - ä¸­ä¼˜å…ˆçº§å‘Šè­¦
  - name: è®¢å•æ‹’ç»ç‡è¿‡é«˜
    condition: order_reject_rate > 15% in 30m
    severity: medium
    notification:
      - type: email
        contacts: [product_team@example.com]
```

---

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0
**æœ€åæ›´æ–°:** 2025-11-02
**ä½œè€…**: Aitachi (44158892@qq.com)

**ç›¸å…³æ–‡æ¡£:**
- [æ™ºèƒ½åˆçº¦æ·±åº¦åˆ†æ](./01-æ™ºèƒ½åˆçº¦æ·±åº¦æŠ€æœ¯åˆ†æ.md)
- [Goåç«¯æ ¸å¿ƒæ¶æ„](./02-Goåç«¯æ ¸å¿ƒæ¶æ„æ·±åº¦è§£æ.md)
- [é¡¹ç›®ç¼ºé™·åˆ†æ](./07-é¡¹ç›®ç¼ºé™·åˆ†æä¸æ”¹è¿›å»ºè®®.md)
