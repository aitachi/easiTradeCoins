# EasiTradeCoins Goåç«¯æ ¸å¿ƒæ¶æ„æ·±åº¦è§£æ

> **æ–‡æ¡£ä½œè€…**: Aitachi
> **è”ç³»é‚®ç®±**: 44158892@qq.com
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-02
> **é€‚ç”¨è¯»è€…**: Goåç«¯å¼€å‘è€…ã€æ¶æ„å¸ˆã€äº¤æ˜“ç³»ç»Ÿå·¥ç¨‹å¸ˆ
> **æŠ€æœ¯éš¾åº¦**: â­â­â­â­â­ (é«˜çº§)

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„è®¾è®¡æ¦‚è§ˆ](#1-æ¶æ„è®¾è®¡æ¦‚è§ˆ)
2. [æ’®åˆå¼•æ“æ ¸å¿ƒå®ç°](#2-æ’®åˆå¼•æ“æ ¸å¿ƒå®ç°)
3. [æ æ†äº¤æ˜“ç³»ç»Ÿ](#3-æ æ†äº¤æ˜“ç³»ç»Ÿ)
4. [ç½‘æ ¼äº¤æ˜“ç­–ç•¥å¼•æ“](#4-ç½‘æ ¼äº¤æ˜“ç­–ç•¥å¼•æ“)
5. [é£æ§ç³»ç»Ÿæ·±åº¦å‰–æ](#5-é£æ§ç³»ç»Ÿæ·±åº¦å‰–æ)
6. [å¹¶å‘å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–](#6-å¹¶å‘å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–)
7. [æœåŠ¡å¯åŠ¨ä¸ä¾èµ–æ³¨å…¥](#7-æœåŠ¡å¯åŠ¨ä¸ä¾èµ–æ³¨å…¥)

---

## 1. æ¶æ„è®¾è®¡æ¦‚è§ˆ

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EasiTradeCoins åç«¯æ¶æ„                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¥å…¥å±‚ (Entry Layer)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Gin Web Framework                                            â”‚
â”‚  â€¢ WebSocket (Gorilla)                                          â”‚
â”‚  â€¢ REST API (JSON)                                              â”‚
â”‚  â€¢ Middleware: CORS, RateLimit, JWT Auth                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡æœåŠ¡å±‚ (Service Layer)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¢å•äº¤æ˜“æœåŠ¡ (14ä¸ªæ ¸å¿ƒæœåŠ¡)                                    â”‚
â”‚  â”œâ”€â”€ OrderService         - è®¢å•ç®¡ç†                            â”‚
â”‚  â”œâ”€â”€ StopOrderMonitor     - æ­¢æŸ/æ­¢ç›ˆç›‘æ§                       â”‚
â”‚  â”œâ”€â”€ OCOOrderService      - OCOè®¢å•                             â”‚
â”‚  â”œâ”€â”€ IcebergOrderService  - å†°å±±è®¢å•                            â”‚
â”‚  â”œâ”€â”€ TWAPOrderService     - TWAPè®¢å•                            â”‚
â”‚  â”‚                                                               â”‚
â”‚  ç­–ç•¥æœåŠ¡                                                        â”‚
â”‚  â”œâ”€â”€ GridTradingService   - ç½‘æ ¼äº¤æ˜“                            â”‚
â”‚  â”œâ”€â”€ DCAService           - å®šæŠ•ç­–ç•¥                            â”‚
â”‚  â”‚                                                               â”‚
â”‚  è¡ç”Ÿå“æœåŠ¡                                                      â”‚
â”‚  â”œâ”€â”€ MarginTradingService - æ æ†äº¤æ˜“                            â”‚
â”‚  â”œâ”€â”€ OptionsService       - æœŸæƒäº¤æ˜“                            â”‚
â”‚  â”‚                                                               â”‚
â”‚  ç¤¾äº¤é‡‘èæœåŠ¡                                                    â”‚
â”‚  â”œâ”€â”€ CopyTradingService   - è·Ÿå•äº¤æ˜“                            â”‚
â”‚  â””â”€â”€ CommunityService     - äº¤æ˜“ç¤¾åŒº                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ ¸å¿ƒå¼•æ“å±‚ (Engine Layer)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ MatchingEngine    - è®¢å•æ’®åˆå¼•æ“ (ä»·æ ¼-æ—¶é—´ä¼˜å…ˆ)             â”‚
â”‚  â€¢ OrderBook         - è®¢å•ç°¿ç®¡ç† (å¤šå¸å¯¹æ”¯æŒ)                  â”‚
â”‚  â€¢ RiskManager       - é£é™©æ§åˆ¶å¼•æ“                             â”‚
â”‚  â€¢ AssetService      - èµ„äº§ç®¡ç†æœåŠ¡                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®å±‚ (Data Layer)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ PostgreSQL (ä¸»æ•°æ®åº“) - 34å¼ è¡¨                               â”‚
â”‚  â€¢ MySQL (å®¡è®¡æ—¥å¿—)                                             â”‚
â”‚  â€¢ Redis (ç¼“å­˜ã€çƒ­ç‚¹æ•°æ®)                                       â”‚
â”‚  â€¢ Kafka (æ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶æµ)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç›‘æ§å±‚ (Monitor Layer)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Prometheus (æŒ‡æ ‡é‡‡é›†)                                        â”‚
â”‚  â€¢ Grafana (å¯è§†åŒ–)                                             â”‚
â”‚  â€¢ WebSocket Hub (å®æ—¶æ¨é€)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆæ€»è§ˆ

| åˆ†ç±» | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **è¯­è¨€** | Go | 1.23+ | ä¸»ç¼–ç¨‹è¯­è¨€ |
| **Webæ¡†æ¶** | Gin | 1.9.1 | HTTPè·¯ç”±ã€ä¸­é—´ä»¶ |
| **ORM** | GORM | 1.30.0 | æ•°æ®åº“æ“ä½œ |
| **WebSocket** | Gorilla WebSocket | 1.5.1 | å®æ—¶é€šä¿¡ |
| **è®¤è¯** | JWT (golang-jwt) | 5.2.0 | èº«ä»½éªŒè¯ |
| **é…ç½®** | Viper | 1.18.2 | é…ç½®ç®¡ç† |
| **é«˜ç²¾åº¦è®¡ç®—** | Decimal | 1.3.1 | é‡‘èè®¡ç®— |
| **æ¶ˆæ¯é˜Ÿåˆ—** | Kafka-Go | 0.4.49 | å¼‚æ­¥æ¶ˆæ¯ |
| **ç¼“å­˜** | go-redis | 9.3.0 | Rediså®¢æˆ·ç«¯ |

### 1.3 é¡¹ç›®ç»“æ„

```
go-backend/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go                 # æœåŠ¡å¯åŠ¨å…¥å£ (193è¡Œ)
â”‚
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config.go               # é…ç½®ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ database.go             # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ models.go               # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â””â”€â”€ handlers.go             # HTTPå¤„ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.go                 # è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                   # ä¸šåŠ¡æœåŠ¡å±‚ (14ä¸ªæœåŠ¡)
â”‚   â”‚   â”œâ”€â”€ order_service.go        # è®¢å•æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ margin_trading_service.go  # æ æ†äº¤æ˜“ (568è¡Œ) â­
â”‚   â”‚   â”œâ”€â”€ grid_trading_service.go    # ç½‘æ ¼äº¤æ˜“ (534è¡Œ) â­
â”‚   â”‚   â”œâ”€â”€ dca_service.go             # DCAå®šæŠ•
â”‚   â”‚   â”œâ”€â”€ copy_trading_service.go    # è·Ÿå•äº¤æ˜“
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ matching/                   # æ’®åˆå¼•æ“
â”‚   â”‚   â”œâ”€â”€ engine.go              # æ’®åˆæ ¸å¿ƒ (393è¡Œ) â­
â”‚   â”‚   â”œâ”€â”€ orderbook.go           # è®¢å•ç°¿ (206è¡Œ) â­
â”‚   â”‚   â””â”€â”€ pricelevel.go          # ä»·æ ¼çº§åˆ«
â”‚   â”‚
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â””â”€â”€ risk_manager.go        # é£æ§ç³»ç»Ÿ (282è¡Œ) â­
â”‚   â”‚
â”‚   â”œâ”€â”€ websocket/                 # WebSocket
â”‚   â”‚   â”œâ”€â”€ hub.go                 # è¿æ¥ç®¡ç†
â”‚   â”‚   â””â”€â”€ client.go              # å®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â””â”€â”€ messaging/
â”‚       â””â”€â”€ kafka.go               # Kafkaæ¶ˆæ¯é˜Ÿåˆ—
â”‚
â”œâ”€â”€ go.mod                         # Goä¾èµ–ç®¡ç†
â””â”€â”€ Dockerfile                     # å®¹å™¨åŒ–é…ç½®
```

---

## 2. æ’®åˆå¼•æ“æ ¸å¿ƒå®ç°

### 2.1 æ’®åˆå¼•æ“æ¶æ„

```
MatchingEngine (æ’®åˆå¼•æ“)
â”‚
â”œâ”€â”€ orderBooks map[symbol]*OrderBook  # å¤šå¸å¯¹è®¢å•ç°¿
â”‚   â”œâ”€â”€ BTC/USDT
â”‚   â”œâ”€â”€ ETH/USDT
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ tradeChan chan *Trade (10,000 buffer) # æˆäº¤é€šé“
â”‚
â””â”€â”€ æ’®åˆç®—æ³•: ä»·æ ¼-æ—¶é—´ä¼˜å…ˆ (Price-Time Priority)
```

### 2.2 è®¢å•æ’®åˆæµç¨‹

#### æ ¸å¿ƒæ’®åˆé€»è¾‘

```go
// go-backend/internal/matching/engine.go:47-91

func (me *MatchingEngine) ProcessOrder(order *models.Order) ([]*models.Trade, error) {
    // [1] è¾“å…¥éªŒè¯
    if err := me.validateOrder(order); err != nil {
        return nil, err
    }

    ob := me.GetOrCreateOrderBook(order.Symbol)

    var trades []*models.Trade

    // [2] æ ¹æ®è®¢å•ç±»å‹é€‰æ‹©æ’®åˆç­–ç•¥
    if order.Type == models.OrderTypeMarket {
        trades = me.matchMarketOrder(ob, order)  // å¸‚ä»·å•æ’®åˆ
    } else {
        trades = me.matchLimitOrder(ob, order)   // é™ä»·å•æ’®åˆ
    }

    // [3] å¤„ç†æœªå®Œå…¨æˆäº¤è®¢å•
    if order.Status == models.OrderStatusPending || order.Status == models.OrderStatusPartial {
        if order.TimeInForce == models.TimeInForceGTC {
            ob.AddOrder(order)  // GTC: ä¿ç•™åˆ°è®¢å•ç°¿
        } else if order.TimeInForce == models.TimeInForceIOC {
            order.Status = models.OrderStatusCancelled  // IOC: ç«‹å³å–æ¶ˆ
        } else if order.TimeInForce == models.TimeInForceFOK {
            // FOK: å…¨éƒ¨æˆäº¤æˆ–å–æ¶ˆ
            if !order.FilledQty.Equal(order.Quantity) {
                order.Status = models.OrderStatusCancelled
                trades = nil  // å›æ»šæ‰€æœ‰æˆäº¤
            }
        }
    }

    // [4] å¼‚æ­¥æ¨é€æˆäº¤è®°å½•
    for _, trade := range trades {
        me.tradeChan <- trade  // å‘é€åˆ°trade channel
    }

    return trades, nil
}
```

**è®¾è®¡äº®ç‚¹:**

1. **TimeInForce æ”¯æŒ**:
   - **GTC** (Good Till Cancel): è®¢å•ä¸€ç›´æœ‰æ•ˆç›´åˆ°æˆäº¤æˆ–å–æ¶ˆ
   - **IOC** (Immediate or Cancel): ç«‹å³æˆäº¤,æœªæˆäº¤éƒ¨åˆ†å–æ¶ˆ
   - **FOK** (Fill or Kill): å…¨éƒ¨æˆäº¤æˆ–å…¨éƒ¨å–æ¶ˆ

2. **éé˜»å¡é€šé“**: `tradeChan` 10,000ç¼“å†²å®¹é‡,æ”¯æŒé«˜é¢‘äº¤æ˜“

3. **åŸå­æ€§ä¿è¯**: FOKè®¢å•å¤±è´¥æ—¶å›æ»šæ‰€æœ‰æˆäº¤

---

#### é™ä»·å•æ’®åˆç®—æ³•

```go
// go-backend/internal/matching/engine.go:94-180

func (me *MatchingEngine) matchLimitOrder(ob *OrderBook, order *models.Order) []*models.Trade {
    var trades []*models.Trade
    order.Status = models.OrderStatusPending

    // ä¹°å•æ’®åˆé€»è¾‘
    if order.Side == models.OrderSideBuy {
        bestAsk, hasAsk := ob.GetBestAsk()  // è·å–æœ€ä½å–ä»·

        // ä»·æ ¼åŒ¹é…æ¡ä»¶: buyPrice >= askPrice
        for hasAsk && bestAsk.LessThanOrEqual(order.Price) {
            level := ob.SellLevels[bestAsk.String()]
            makerOrder := level.GetFirstOrder()  // ä»·æ ¼-æ—¶é—´ä¼˜å…ˆ

            // æ‰§è¡Œæˆäº¤
            trade := me.executeTrade(order, makerOrder, bestAsk)
            if trade != nil {
                trades = append(trades, trade)
            }

            // æ›´æ–°makerè®¢å•çŠ¶æ€
            if makerOrder.FilledQty.Equal(makerOrder.Quantity) {
                makerOrder.Status = models.OrderStatusFilled
                ob.RemoveOrder(makerOrder.ID)
            } else {
                makerOrder.Status = models.OrderStatusPartial
                level.UpdateVolume()
            }

            // æ£€æŸ¥takerè®¢å•æ˜¯å¦å®Œå…¨æˆäº¤
            if order.FilledQty.Equal(order.Quantity) {
                order.Status = models.OrderStatusFilled
                break
            }

            bestAsk, hasAsk = ob.GetBestAsk()  // è·å–ä¸‹ä¸€ä¸ªä»·æ ¼çº§åˆ«
        }
    } else {
        // å–å•æ’®åˆé€»è¾‘ (ç±»ä¼¼,ç•¥)
        ...
    }

    return trades
}
```

**æ’®åˆè§„åˆ™:**

```
ä¹°å•æ’®åˆæ¡ä»¶: order.Price >= bestAsk
å–å•æ’®åˆæ¡ä»¶: order.Price <= bestBid

æˆäº¤ä»·æ ¼: Makerè®¢å•ä»·æ ¼ (ä»·æ ¼ä¼˜å…ˆåŸåˆ™)
```

**ç®—æ³•å¤æ‚åº¦:**

- **æ—¶é—´å¤æ‚åº¦**: O(n Ã— log k)
  - n: æˆäº¤æ¬¡æ•°
  - k: ä»·æ ¼çº§åˆ«æ•°é‡
- **ç©ºé—´å¤æ‚åº¦**: O(m) (m = è®¢å•æ€»æ•°)

---

#### æˆäº¤æ‰§è¡Œå‡½æ•°

```go
// go-backend/internal/matching/engine.go:277-337

func (me *MatchingEngine) executeTrade(buyOrder, sellOrder *models.Order, price decimal.Decimal) *models.Trade {
    // [1] è®¡ç®—æˆäº¤æ•°é‡ (å–ä¹°å–åŒæ–¹å‰©ä½™æ•°é‡çš„æœ€å°å€¼)
    buyRemaining := buyOrder.Quantity.Sub(buyOrder.FilledQty)
    sellRemaining := sellOrder.Quantity.Sub(sellOrder.FilledQty)

    var tradeQty decimal.Decimal
    if buyRemaining.LessThan(sellRemaining) {
        tradeQty = buyRemaining
    } else {
        tradeQty = sellRemaining
    }

    if tradeQty.LessThanOrEqual(decimal.Zero) {
        return nil
    }

    // [2] è®¡ç®—æˆäº¤é‡‘é¢
    tradeAmount := tradeQty.Mul(price)

    // [3] è®¡ç®—æ‰‹ç»­è´¹ (0.1%)
    feeRate := decimal.NewFromFloat(0.001)
    buyerFee := tradeAmount.Mul(feeRate)      // ä¹°æ–¹æ‰‹ç»­è´¹ (é‡‘é¢)
    sellerFee := tradeQty.Mul(feeRate)        // å–æ–¹æ‰‹ç»­è´¹ (æ•°é‡)

    // [4] æ›´æ–°ä¹°å•çŠ¶æ€
    buyOrder.FilledQty = buyOrder.FilledQty.Add(tradeQty)
    buyOrder.FilledAmount = buyOrder.FilledAmount.Add(tradeAmount)
    buyOrder.Fee = buyOrder.Fee.Add(buyerFee)
    buyOrder.UpdateTime = time.Now()

    // è®¡ç®—å¹³å‡æˆäº¤ä»·
    if buyOrder.FilledQty.GreaterThan(decimal.Zero) {
        buyOrder.AvgPrice = buyOrder.FilledAmount.Div(buyOrder.FilledQty)
    }

    // [5] æ›´æ–°å–å•çŠ¶æ€ (åŒä¸Š)
    sellOrder.FilledQty = sellOrder.FilledQty.Add(tradeQty)
    // ...

    // [6] åˆ›å»ºæˆäº¤è®°å½•
    trade := &models.Trade{
        ID:          uuid.New().String(),
        Symbol:      buyOrder.Symbol,
        BuyOrderID:  buyOrder.ID,
        SellOrderID: sellOrder.ID,
        BuyerID:     buyOrder.UserID,
        SellerID:    sellOrder.UserID,
        Price:       price,
        Quantity:    tradeQty,
        Amount:      tradeAmount,
        BuyerFee:    buyerFee,
        SellerFee:   sellerFee,
        TradeTime:   time.Now(),
    }

    return trade
}
```

**æ‰‹ç»­è´¹è®¾è®¡:**

| è§’è‰² | æ‰‹ç»­è´¹ç‡ | è®¡è´¹åŸºç¡€ | ç¤ºä¾‹ |
|------|---------|---------|------|
| ä¹°æ–¹ | 0.1% | æˆäº¤é‡‘é¢ | ä¹°100 USDTçš„BTC,æ‰‹ç»­è´¹=0.1 USDT |
| å–æ–¹ | 0.1% | æˆäº¤æ•°é‡ | å–0.01 BTC,æ‰‹ç»­è´¹=0.00001 BTC |

---

### 2.3 è®¢å•ç°¿å®ç°

#### è®¢å•ç°¿æ•°æ®ç»“æ„

```go
// go-backend/internal/matching/orderbook.go:15-22

type OrderBook struct {
    Symbol     string
    BuyLevels  map[string]*PriceLevel  // ä¹°æ–¹ä»·æ ¼çº§åˆ« (key=price)
    SellLevels map[string]*PriceLevel  // å–æ–¹ä»·æ ¼çº§åˆ«
    OrderMap   map[string]*models.Order // è®¢å•å¿«é€ŸæŸ¥æ‰¾ (key=orderID)
    mu         sync.RWMutex             // è¯»å†™é”
}
```

**è®¾è®¡ä¼˜åŠ¿:**

1. **å“ˆå¸Œè¡¨ + é“¾è¡¨**: O(1)ä»·æ ¼çº§åˆ«æŸ¥æ‰¾, O(1)è®¢å•æ’å…¥
2. **åŒå‘ç´¢å¼•**:
   - `BuyLevels/SellLevels`: æŒ‰ä»·æ ¼ç»„ç»‡
   - `OrderMap`: æŒ‰è®¢å•IDå¿«é€ŸæŸ¥æ‰¾
3. **è¯»å†™é”**: æ”¯æŒå¹¶å‘è¯»å–,å†™å…¥æ—¶äº’æ–¥

#### æœ€ä¼˜ä»·æ ¼æŸ¥è¯¢

```go
// go-backend/internal/matching/orderbook.go:107-127

func (ob *OrderBook) GetBestBid() (decimal.Decimal, bool) {
    ob.mu.RLock()
    defer ob.mu.RUnlock()

    if len(ob.BuyLevels) == 0 {
        return decimal.Zero, false
    }

    var bestPrice decimal.Decimal
    first := true

    // éå†æ‰€æœ‰ä¹°å•ä»·æ ¼çº§åˆ«,æ‰¾æœ€é«˜ä»·
    for priceStr := range ob.BuyLevels {
        price, _ := decimal.NewFromString(priceStr)
        if first || price.GreaterThan(bestPrice) {
            bestPrice = price
            first = false
        }
    }

    return bestPrice, true
}
```

**ä¼˜åŒ–å»ºè®®:**

```go
// âš ï¸ å½“å‰å®ç°: O(n) æ—¶é—´å¤æ‚åº¦

// âœ… å»ºè®®ä¼˜åŒ–: ä½¿ç”¨å † (heap) æˆ–çº¢é»‘æ ‘ç»´æŠ¤æœ€ä¼˜ä»·æ ¼
// ä¼˜åŒ–åå¤æ‚åº¦: O(1) æŸ¥è¯¢, O(log n) æ’å…¥/åˆ é™¤
```

#### æ·±åº¦æŸ¥è¯¢å®ç°

```go
// go-backend/internal/matching/orderbook.go:153-198

func (ob *OrderBook) GetDepth(depth int) ([]PriceLevelInfo, []PriceLevelInfo) {
    ob.mu.RLock()
    defer ob.mu.RUnlock()

    // [1] è·å–ä¹°å•ä»·æ ¼å¹¶æ’åº (é™åº)
    buyPrices := make([]decimal.Decimal, 0, len(ob.BuyLevels))
    for priceStr := range ob.BuyLevels {
        price, _ := decimal.NewFromString(priceStr)
        buyPrices = append(buyPrices, price)
    }
    sort.Slice(buyPrices, func(i, j int) bool {
        return buyPrices[i].GreaterThan(buyPrices[j])  // é™åº
    })

    // [2] æ„å»ºä¹°ç›˜æ·±åº¦
    bids := make([]PriceLevelInfo, 0, depth)
    for i := 0; i < len(buyPrices) && i < depth; i++ {
        level := ob.BuyLevels[buyPrices[i].String()]
        bids = append(bids, PriceLevelInfo{
            Price:  buyPrices[i],
            Volume: level.GetVolume(),   // è¯¥ä»·æ ¼çš„æ€»æŒ‚å•é‡
            Count:  level.GetOrderCount(), // è®¢å•æ•°é‡
        })
    }

    // [3] å–ç›˜æ·±åº¦ (å‡åºæ’åº,ç•¥)
    ...

    return bids, asks
}
```

**æ·±åº¦æ•°æ®ç¤ºä¾‹:**

```json
{
  "bids": [
    {"price": "50000.00", "volume": "10.5", "count": 15},
    {"price": "49999.00", "volume": "20.3", "count": 25},
    {"price": "49998.00", "volume": "15.8", "count": 10}
  ],
  "asks": [
    {"price": "50001.00", "volume": "8.2", "count": 12},
    {"price": "50002.00", "volume": "12.5", "count": 18},
    {"price": "50003.00", "volume": "9.7", "count": 14}
  ]
}
```

---

## 3. æ æ†äº¤æ˜“ç³»ç»Ÿ

### 3.1 ç³»ç»Ÿæ¶æ„

```
MarginTradingService (æ æ†äº¤æ˜“æœåŠ¡)
â”‚
â”œâ”€â”€ MarginAccount (ä¿è¯é‡‘è´¦æˆ·)
â”‚   â”œâ”€â”€ Collateral      # æŠµæŠ¼èµ„äº§
â”‚   â”œâ”€â”€ Borrowed        # å€Ÿè´·é‡‘é¢
â”‚   â”œâ”€â”€ Interest        # ç´¯è®¡åˆ©æ¯
â”‚   â”œâ”€â”€ Equity          # å‡€èµ„äº§ = Collateral - Borrowed - Interest
â”‚   â”œâ”€â”€ MarginLevel     # ä¿è¯é‡‘ç‡ = Equity / Borrowed
â”‚   â””â”€â”€ Leverage        # æ æ†å€æ•° (1x-10x)
â”‚
â”œâ”€â”€ MarginPosition (æ æ†æŒä»“)
â”‚   â”œâ”€â”€ Side            # long/short
â”‚   â”œâ”€â”€ EntryPrice      # å¼€ä»“ä»·
â”‚   â”œâ”€â”€ Quantity        # æŒä»“æ•°é‡
â”‚   â”œâ”€â”€ LiquidationPrice # å¼ºå¹³ä»·
â”‚   â”œâ”€â”€ UnrealizedPnL   # æœªå®ç°ç›ˆäº
â”‚   â””â”€â”€ RealizedPnL     # å·²å®ç°ç›ˆäº
â”‚
â””â”€â”€ MarginLoan (å€Ÿè´·è®°å½•)
    â”œâ”€â”€ Principal       # æœ¬é‡‘
    â”œâ”€â”€ Interest        # åˆ©æ¯
    â”œâ”€â”€ InterestRate    # æ—¥åˆ©ç‡ (0.01%)
    â””â”€â”€ LastAccrueTime  # æœ€åè®¡æ¯æ—¶é—´
```

### 3.2 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### åŠŸèƒ½ 1: å¼€ä»“é€»è¾‘

```go
// go-backend/internal/services/margin_trading_service.go:285-344

func (s *MarginTradingService) OpenPosition(
    ctx context.Context,
    userID uint,
    symbol string,
    side string,         // "long" æˆ– "short"
    price decimal.Decimal,
    quantity decimal.Decimal,
    leverage int,        // æ æ†å€æ•° (1-10)
    stopLoss, takeProfit *decimal.Decimal,
) (*MarginPosition, error) {
    s.mutex.Lock()
    defer s.mutex.Unlock()

    account, err := s.GetOrCreateMarginAccount(ctx, userID)
    if err != nil {
        return nil, err
    }

    // [1] éªŒè¯æ æ†å€æ•°
    if leverage > account.MaxLeverage {
        return nil, fmt.Errorf("leverage %d exceeds max leverage %d", leverage, account.MaxLeverage)
    }

    // [2] è®¡ç®—æ‰€éœ€ä¿è¯é‡‘
    positionValue := price.Mul(quantity)  // æŒä»“ä»·å€¼
    requiredMargin := positionValue.Div(decimal.NewFromInt(int64(leverage)))

    // [3] æ£€æŸ¥è´¦æˆ·ä½™é¢
    availableMargin := account.Equity
    if requiredMargin.GreaterThan(availableMargin) {
        return nil, errors.New("insufficient margin")
    }

    // [4] è®¡ç®—å¼ºå¹³ä»·æ ¼ â­
    liquidationPrice := s.calculateLiquidationPrice(price, leverage, side, account.MaintenanceRate)

    // [5] åˆ›å»ºæŒä»“
    position := &MarginPosition{
        UserID:           userID,
        Symbol:           symbol,
        Side:             side,
        EntryPrice:       price,
        CurrentPrice:     price,
        Quantity:         quantity,
        Leverage:         leverage,
        Margin:           requiredMargin,
        UnrealizedPnL:    decimal.Zero,
        RealizedPnL:      decimal.Zero,
        LiquidationPrice: liquidationPrice,
        StopLoss:         stopLoss,
        TakeProfit:       takeProfit,
        Status:           "open",
        OpenTime:         time.Now(),
    }

    if err := s.db.Create(position).Error; err != nil {
        return nil, err
    }

    return position, nil
}
```

**ä¿è¯é‡‘è®¡ç®—ç¤ºä¾‹:**

```
åœºæ™¯: å¼€10å€æ æ†åšå¤šBTC
- å½“å‰ä»·æ ¼: 50,000 USDT
- è´­ä¹°æ•°é‡: 0.1 BTC
- æŒä»“ä»·å€¼: 50,000 Ã— 0.1 = 5,000 USDT
- æ‰€éœ€ä¿è¯é‡‘: 5,000 / 10 = 500 USDT

å¦‚æœè´¦æˆ·Equity < 500 USDT â†’ å¼€ä»“å¤±è´¥
```

---

#### åŠŸèƒ½ 2: å¼ºå¹³ä»·æ ¼è®¡ç®—

```go
// go-backend/internal/services/margin_trading_service.go:347-366

func (s *MarginTradingService) calculateLiquidationPrice(
    entryPrice decimal.Decimal,
    leverage int,
    side string,
    maintenanceRate decimal.Decimal,  // ç»´æŒä¿è¯é‡‘ç‡ (é»˜è®¤10%)
) decimal.Decimal {
    leverageDec := decimal.NewFromInt(int64(leverage))

    if side == "long" {
        // åšå¤šå¼ºå¹³ä»· = å¼€ä»“ä»· Ã— (1 - 1/æ æ† + ç»´æŒä¿è¯é‡‘ç‡)
        return entryPrice.Mul(
            decimal.NewFromInt(1).
                Sub(decimal.NewFromInt(1).Div(leverageDec)).
                Add(maintenanceRate),
        )
    } else {
        // åšç©ºå¼ºå¹³ä»· = å¼€ä»“ä»· Ã— (1 + 1/æ æ† - ç»´æŒä¿è¯é‡‘ç‡)
        return entryPrice.Mul(
            decimal.NewFromInt(1).
                Add(decimal.NewFromInt(1).Div(leverageDec)).
                Sub(maintenanceRate),
        )
    }
}
```

**å¼ºå¹³ä»·æ ¼å…¬å¼æ¨å¯¼:**

```
åšå¤š (Long) å¼ºå¹³æ¡ä»¶:
(å½“å‰ä»· - å¼€ä»“ä»·) Ã— æ•°é‡ / (ä¿è¯é‡‘ + æ‰‹ç»­è´¹) = -ç»´æŒä¿è¯é‡‘ç‡

ç®€åŒ–å:
å¼ºå¹³ä»· = å¼€ä»“ä»· Ã— (1 - 1/æ æ† + ç»´æŒç‡)

ç¤ºä¾‹ (10xæ æ†, 10%ç»´æŒç‡):
- å¼€ä»“ä»·: 50,000 USDT
- å¼ºå¹³ä»·: 50,000 Ã— (1 - 0.1 + 0.1) = 50,000 Ã— 1.0 = 50,000 USDT

åšç©º (Short) å¼ºå¹³æ¡ä»¶:
å¼ºå¹³ä»· = å¼€ä»“ä»· Ã— (1 + 1/æ æ† - ç»´æŒç‡)

ç¤ºä¾‹:
- å¼€ä»“ä»·: 50,000 USDT
- å¼ºå¹³ä»·: 50,000 Ã— (1 + 0.1 - 0.1) = 50,000 Ã— 1.0 = 50,000 USDT
```

---

#### åŠŸèƒ½ 3: æŒä»“æ›´æ–°ä¸ç›ˆäºè®¡ç®—

```go
// go-backend/internal/services/margin_trading_service.go:369-401

func (s *MarginTradingService) UpdatePosition(ctx context.Context, positionID uint, currentPrice decimal.Decimal) error {
    var position MarginPosition
    if err := s.db.First(&position, positionID).Error; err != nil {
        return err
    }

    position.CurrentPrice = currentPrice

    // [1] è®¡ç®—æœªå®ç°ç›ˆäº
    if position.Side == "long" {
        // åšå¤šç›ˆäº = (å½“å‰ä»· - å¼€ä»“ä»·) Ã— æ•°é‡
        position.UnrealizedPnL = currentPrice.Sub(position.EntryPrice).Mul(position.Quantity)
    } else {
        // åšç©ºç›ˆäº = (å¼€ä»“ä»· - å½“å‰ä»·) Ã— æ•°é‡
        position.UnrealizedPnL = position.EntryPrice.Sub(currentPrice).Mul(position.Quantity)
    }

    position.UpdateTime = time.Now()

    // [2] æ£€æŸ¥æ˜¯å¦è§¦å‘å¼ºå¹³
    if s.shouldLiquidate(&position) {
        return s.LiquidatePosition(ctx, positionID)
    }

    // [3] æ£€æŸ¥æ­¢æŸæ­¢ç›ˆ
    if position.StopLoss != nil && s.shouldTriggerStopLoss(&position) {
        return s.ClosePosition(ctx, positionID, currentPrice)
    }

    if position.TakeProfit != nil && s.shouldTriggerTakeProfit(&position) {
        return s.ClosePosition(ctx, positionID, currentPrice)
    }

    return s.db.Save(&position).Error
}
```

**ç›ˆäºè®¡ç®—ç¤ºä¾‹:**

```
åšå¤šåœºæ™¯:
- å¼€ä»“ä»·: 50,000 USDT
- å½“å‰ä»·: 55,000 USDT
- æ•°é‡: 0.1 BTC
- æœªå®ç°ç›ˆäº = (55,000 - 50,000) Ã— 0.1 = 500 USDT

åšç©ºåœºæ™¯:
- å¼€ä»“ä»·: 50,000 USDT
- å½“å‰ä»·: 45,000 USDT
- æ•°é‡: 0.1 BTC
- æœªå®ç°ç›ˆäº = (50,000 - 45,000) Ã— 0.1 = 500 USDT
```

---

#### åŠŸèƒ½ 4: å¼ºå¹³æ‰§è¡Œ

```go
// go-backend/internal/services/margin_trading_service.go:489-535

func (s *MarginTradingService) LiquidatePosition(ctx context.Context, positionID uint) error {
    s.mutex.Lock()
    defer s.mutex.Unlock()

    var position MarginPosition
    if err := s.db.First(&position, positionID).Error; err != nil {
        return err
    }

    // [1] æ ‡è®°ä¸ºå¼ºå¹³
    position.Status = "liquidated"

    // [2] è®¡ç®—å¼ºå¹³æ—¶çš„ç›ˆäº (é€šå¸¸ä¸ºè´Ÿ)
    position.RealizedPnL = position.LiquidationPrice.Sub(position.EntryPrice).Mul(position.Quantity)
    if position.Side == "short" {
        position.RealizedPnL = position.RealizedPnL.Neg()
    }

    now := time.Now()
    position.CloseTime = &now

    return s.db.Transaction(func(tx *gorm.DB) error {
        if err := tx.Save(&position).Error; err != nil {
            return err
        }

        // [3] æ›´æ–°ä¿è¯é‡‘è´¦æˆ·
        var account MarginAccount
        if err := tx.Where("user_id = ?", position.UserID).First(&account).Error; err != nil {
            return err
        }

        // âš ï¸ ä¿è¯é‡‘å…¨éƒ¨æŸå¤±
        account.Collateral = account.Collateral.Sub(position.Margin)
        account.Equity = account.Collateral.Sub(account.Borrowed).Sub(account.Interest)

        // [4] æ£€æŸ¥è´¦æˆ·æ˜¯å¦éœ€è¦å¼ºå¹³
        if account.Borrowed.GreaterThan(decimal.Zero) {
            account.MarginLevel = account.Equity.Div(account.Borrowed)

            if account.MarginLevel.LessThan(account.MaintenanceRate) {
                account.Status = "liquidating"  // è§¦å‘è´¦æˆ·çº§å¼ºå¹³
            }
        }

        return tx.Save(&account).Error
    })
}
```

**å¼ºå¹³åæœ:**

1. **æŒä»“å±‚é¢**: ä¿è¯é‡‘å…¨éƒ¨æŸå¤±,ä»“ä½å…³é—­
2. **è´¦æˆ·å±‚é¢**: å¦‚æœä¿è¯é‡‘ç‡ < ç»´æŒç‡,è§¦å‘è´¦æˆ·å¼ºå¹³

---

### 3.3 åˆ©æ¯è®¡ç®—æœºåˆ¶

```go
// go-backend/internal/services/margin_trading_service.go:273-282

func (s *MarginTradingService) accrueInterest(loan *MarginLoan) {
    now := time.Now()
    days := now.Sub(loan.LastAccrueTime).Hours() / 24.0

    if days > 0 {
        // æ—¥åˆ©ç‡å¤åˆ©è®¡ç®—
        interest := loan.Principal.Mul(loan.InterestRate).Mul(decimal.NewFromFloat(days))
        loan.Interest = loan.Interest.Add(interest)
        loan.LastAccrueTime = now
    }
}
```

**åˆ©æ¯è®¡ç®—ç¤ºä¾‹:**

```
å€Ÿè´·: 10,000 USDT
æ—¥åˆ©ç‡: 0.01% (0.0001)
æ—¶é—´: 30å¤©

åˆ©æ¯ = 10,000 Ã— 0.0001 Ã— 30 = 30 USDT
```

---

## 4. ç½‘æ ¼äº¤æ˜“ç­–ç•¥å¼•æ“

### 4.1 ç½‘æ ¼äº¤æ˜“åŸç†

```
ç½‘æ ¼äº¤æ˜“ç­–ç•¥:
åœ¨ä»·æ ¼åŒºé—´å†…è®¾ç½®å¤šä¸ªä¹°å–ç½‘æ ¼,è‡ªåŠ¨ä½ä¹°é«˜å–

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ä»·æ ¼åŒºé—´: 50,000 - 60,000 USDT (10æ ¼)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å–å•ç½‘æ ¼:
60,000 â”œâ”€ å–å• #9 (å–å‡º)
59,000 â”œâ”€ å–å• #8
58,000 â”œâ”€ å–å• #7
57,000 â”œâ”€ å–å• #6
56,000 â”œâ”€ å–å• #5
       â”œâ”€ å½“å‰ä»·æ ¼ 55,500 â†â”€â”€â”€â”€â”€â”€â”€â”
55,000 â”œâ”€ ä¹°å• #4                  â”‚
54,000 â”œâ”€ ä¹°å• #3 (ä¹°å…¥)            â”‚
53,000 â”œâ”€ ä¹°å• #2                  â”‚
52,000 â”œâ”€ ä¹°å• #1                  â”‚
51,000 â”œâ”€ ä¹°å• #0                  â”‚
50,000 â””â”€ ä¸‹é™ä»·æ ¼                 â”‚
                                   â”‚
åˆ©æ¶¦æ¥æº:                           â”‚
ä»·æ ¼ä¸Šæ¶¨ â†’ è§¦å‘å–å• â†’ èµšå–å·®ä»· â”€â”€â”€â”€â”€â”€â”˜
ä»·æ ¼ä¸‹è·Œ â†’ è§¦å‘ä¹°å• â†’ ç­‰å¾…åå¼¹
```

### 4.2 æ ¸å¿ƒå®ç°

#### åŠŸèƒ½ 1: åˆ›å»ºç½‘æ ¼ç­–ç•¥

```go
// go-backend/internal/services/grid_trading_service.go:95-151

func (s *GridTradingService) CreateGridStrategy(
    ctx context.Context,
    userID uint,
    symbol string,
    lowerPrice, upperPrice decimal.Decimal,  // ä»·æ ¼åŒºé—´
    gridNum int,                              // ç½‘æ ¼æ•°é‡
    totalInvestment decimal.Decimal,          // æ€»æŠ•èµ„é‡‘é¢
    autoRestart bool,                         // è‡ªåŠ¨é‡å¯
    stopLoss, takeProfit *decimal.Decimal,
) (*GridStrategy, error) {
    s.mutex.Lock()
    defer s.mutex.Unlock()

    // [1] å‚æ•°éªŒè¯
    if err := s.validateParams(lowerPrice, upperPrice, gridNum, totalInvestment); err != nil {
        return nil, err
    }

    // [2] è®¡ç®—ç½‘æ ¼å‚æ•°
    priceStep := upperPrice.Sub(lowerPrice).Div(decimal.NewFromInt(int64(gridNum)))
    quantityPerGrid := totalInvestment.Div(decimal.NewFromInt(int64(gridNum)))

    // [3] åˆ›å»ºç­–ç•¥å¯¹è±¡
    strategy := &GridStrategy{
        ID:              fmt.Sprintf("GRID-%d-%d", userID, time.Now().UnixNano()),
        UserID:          userID,
        Symbol:          symbol,
        LowerPrice:      lowerPrice,
        UpperPrice:      upperPrice,
        GridNum:         gridNum,
        TotalInvestment: totalInvestment,
        QuantityPerGrid: quantityPerGrid,
        TotalProfit:     decimal.Zero,
        AutoRestart:     autoRestart,
        StopLoss:        stopLoss,
        TakeProfit:      takeProfit,
        Status:          "pending",
        CreateTime:      time.Now(),
    }

    // [4] ä¿å­˜ç­–ç•¥
    if err := s.db.Create(strategy).Error; err != nil {
        return nil, fmt.Errorf("failed to create grid strategy: %w", err)
    }

    // [5] åˆ›å»ºæ‰€æœ‰ç½‘æ ¼å±‚çº§
    if err := s.createGridLevels(ctx, strategy, priceStep); err != nil {
        return nil, fmt.Errorf("failed to create grid levels: %w", err)
    }

    // [6] å¯åŠ¨å¼‚æ­¥æ‰§è¡Œå™¨
    go s.runGridStrategy(ctx, strategy.ID)

    return strategy, nil
}
```

**ç½‘æ ¼å‚æ•°è®¡ç®—:**

```
ç¤ºä¾‹:
- ä»·æ ¼åŒºé—´: [50,000, 60,000]
- ç½‘æ ¼æ•°é‡: 10
- æ€»æŠ•èµ„: 10,000 USDT

è®¡ç®—:
- ä»·æ ¼æ­¥é•¿ = (60,000 - 50,000) / 10 = 1,000 USDT
- æ¯æ ¼æŠ•èµ„ = 10,000 / 10 = 1,000 USDT

ç½‘æ ¼å±‚çº§:
Level 0: 50,000 USDT
Level 1: 51,000 USDT
Level 2: 52,000 USDT
...
Level 9: 59,000 USDT
```

---

#### åŠŸèƒ½ 2: ç½‘æ ¼å±‚çº§åˆ›å»º

```go
// go-backend/internal/services/grid_trading_service.go:179-198

func (s *GridTradingService) createGridLevels(ctx context.Context, strategy *GridStrategy, priceStep decimal.Decimal) error {
    levels := make([]GridLevel, strategy.GridNum)

    for i := 0; i < strategy.GridNum; i++ {
        price := strategy.LowerPrice.Add(priceStep.Mul(decimal.NewFromInt(int64(i))))

        levels[i] = GridLevel{
            StrategyID: strategy.ID,
            Level:      i,
            Price:      price,
            BuyFilled:  false,
            SellFilled: false,
            Profit:     decimal.Zero,
            CreateTime: time.Now(),
        }
    }

    return s.db.Create(&levels).Error
}
```

---

#### åŠŸèƒ½ 3: ç½‘æ ¼æ‰§è¡Œå™¨

```go
// go-backend/internal/services/grid_trading_service.go:200-219

func (s *GridTradingService) runGridStrategy(ctx context.Context, strategyID string) {
    ticker := time.NewTicker(5 * time.Second)  // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    defer ticker.Stop()

    // åˆå§‹åŒ–ç½‘æ ¼è®¢å•
    s.initializeGridOrders(ctx, strategyID)

    for {
        select {
        case <-ctx.Done():
            return  // ä¸Šä¸‹æ–‡å–æ¶ˆ
        case <-ticker.C:
            shouldStop := s.updateGridStrategy(ctx, strategyID)
            if shouldStop {
                return
            }
        }
    }
}
```

**æ‰§è¡Œå™¨èŒè´£:**

1. **åˆå§‹åŒ–**: æ ¹æ®å½“å‰ä»·æ ¼åˆ›å»ºä¹°å•/å–å•
2. **ç›‘æ§**: æ¯5ç§’æ£€æŸ¥è®¢å•æˆäº¤çŠ¶æ€
3. **é‡å¯**: æˆäº¤åè‡ªåŠ¨åˆ›å»ºæ–°è®¢å• (å¦‚æœ `autoRestart=true`)
4. **æ­¢ç›ˆæ­¢æŸ**: æ£€æŸ¥ä»·æ ¼è§¦å‘æ¡ä»¶

---

#### åŠŸèƒ½ 4: ç½‘æ ¼è®¢å•åˆå§‹åŒ–

```go
// go-backend/internal/services/grid_trading_service.go:222-268

func (s *GridTradingService) initializeGridOrders(ctx context.Context, strategyID string) {
    // [1] è·å–å½“å‰å¸‚åœºä»·æ ¼
    var lastTrade models.Trade
    s.db.Where("symbol = ?", strategy.Symbol).
        Order("trade_time DESC").
        First(&lastTrade)

    currentPrice := lastTrade.Price

    // [2] è·å–æ‰€æœ‰ç½‘æ ¼å±‚çº§
    var levels []GridLevel
    s.db.Where("strategy_id = ?", strategyID).
        Order("level ASC").
        Find(&levels)

    // [3] æ ¹æ®å½“å‰ä»·æ ¼åˆ›å»ºè®¢å•
    for i := range levels {
        level := &levels[i]

        if level.Price.LessThan(currentPrice) && level.BuyOrderID == nil {
            // ä»·æ ¼ä½äºå½“å‰ä»· â†’ åˆ›å»ºä¹°å•
            s.createBuyOrder(ctx, &strategy, level)
        } else if level.Price.GreaterThan(currentPrice) && level.SellOrderID == nil {
            // ä»·æ ¼é«˜äºå½“å‰ä»· â†’ åˆ›å»ºå–å• (éœ€è¦å…ˆæœ‰æŒä»“)
            // å®é™…å®ç°éœ€è¦æ£€æŸ¥ç”¨æˆ·æŒä»“
        }
    }

    strategy.Status = "active"
    s.db.Save(&strategy)
}
```

**åˆå§‹åŒ–ç¤ºä¾‹:**

```
å½“å‰ä»·æ ¼: 55,500 USDT

åˆå§‹åŒ–å:
- Level 0 (50,000) â†’ åˆ›å»ºä¹°å•
- Level 1 (51,000) â†’ åˆ›å»ºä¹°å•
- Level 2 (52,000) â†’ åˆ›å»ºä¹°å•
- Level 3 (53,000) â†’ åˆ›å»ºä¹°å•
- Level 4 (54,000) â†’ åˆ›å»ºä¹°å•
- Level 5 (55,000) â†’ åˆ›å»ºä¹°å•
- Level 6 (56,000) â†’ (éœ€è¦æŒä»“æ‰èƒ½åˆ›å»ºå–å•)
- Level 7 (57,000) â†’ (éœ€è¦æŒä»“)
...
```

---

#### åŠŸèƒ½ 5: ç½‘æ ¼å±‚çº§ç›‘æ§

```go
// go-backend/internal/services/grid_trading_service.go:375-425

func (s *GridTradingService) checkGridLevel(ctx context.Context, strategy *GridStrategy, level *GridLevel) {
    // [1] æ£€æŸ¥ä¹°å•çŠ¶æ€
    if level.BuyOrderID != nil && !level.BuyFilled {
        var buyOrder models.Order
        if err := s.db.First(&buyOrder, "id = ?", *level.BuyOrderID).Error; err == nil {
            if buyOrder.Status == models.OrderStatusFilled {
                level.BuyFilled = true
                strategy.ActiveBuyOrders--

                // ä¹°å•æˆäº¤ â†’ åˆ›å»ºå–å•
                s.createSellOrder(ctx, strategy, level, buyOrder.FilledQty)

                level.UpdateTime = time.Now()
                s.db.Save(level)
            }
        }
    }

    // [2] æ£€æŸ¥å–å•çŠ¶æ€
    if level.SellOrderID != nil && !level.SellFilled {
        var sellOrder models.Order
        if err := s.db.First(&sellOrder, "id = ?", *level.SellOrderID).Error; err == nil {
            if sellOrder.Status == models.OrderStatusFilled {
                level.SellFilled = true
                strategy.ActiveSellOrders--
                strategy.CompletedGrids++  // å®Œæˆç½‘æ ¼æ•°+1

                // [3] è®¡ç®—åˆ©æ¶¦
                var buyOrder models.Order
                s.db.First(&buyOrder, "id = ?", *level.BuyOrderID)
                profit := sellOrder.FilledAmount.Sub(buyOrder.FilledAmount)
                level.Profit = profit
                strategy.TotalProfit = strategy.TotalProfit.Add(profit)

                // [4] è‡ªåŠ¨é‡å¯ç½‘æ ¼
                if strategy.AutoRestart {
                    level.BuyFilled = false
                    level.SellFilled = false
                    level.BuyOrderID = nil
                    level.SellOrderID = nil
                    s.createBuyOrder(ctx, strategy, level)  // é‡æ–°åˆ›å»ºä¹°å•
                }

                level.UpdateTime = time.Now()
                s.db.Save(level)
            }
        }
    }
}
```

**ç½‘æ ¼ç›ˆåˆ©é€»è¾‘:**

```
Level 3 ç½‘æ ¼ (52,000 USDT):
1. ä¹°å•æˆäº¤: èŠ±è´¹ 1,000 USDT è´­ä¹° 0.01923 BTC
2. ä»·æ ¼ä¸Šæ¶¨åˆ° 53,000
3. å–å•æˆäº¤: å–å‡º 0.01923 BTC è·å¾— 1,019.23 USDT
4. åˆ©æ¶¦: 1,019.23 - 1,000 = 19.23 USDT

å¦‚æœ autoRestart=true:
â†’ å†æ¬¡åœ¨52,000åˆ›å»ºä¹°å•,ç­‰å¾…ä¸‹æ¬¡æœºä¼š
```

---

## 5. é£æ§ç³»ç»Ÿæ·±åº¦å‰–æ

### 5.1 é£æ§ä½“ç³»æ¶æ„

```
RiskManager (é£æ§ç®¡ç†å™¨)
â”‚
â”œâ”€â”€ è®¢å•é£æ§
â”‚   â”œâ”€â”€ è®¢å•é‡‘é¢é™åˆ¶ (maxOrderSize)
â”‚   â”œâ”€â”€ ä»·æ ¼åç¦»æ£€æµ‹ (checkPriceDeviation)
â”‚   â”œâ”€â”€ è®¢å•é¢‘ç‡é™åˆ¶ (checkOrderFrequency)
â”‚   â””â”€â”€ ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
â”‚
â”œâ”€â”€ æç°é£æ§
â”‚   â”œâ”€â”€ KYCç­‰çº§éªŒè¯
â”‚   â”œâ”€â”€ æ¯æ—¥æç°é™é¢ (dailyWithdrawalLimit)
â”‚   â”œâ”€â”€ é¦–æ¬¡æç°æ£€æµ‹
â”‚   â””â”€â”€ æ´—é’±æ¨¡å¼è¯†åˆ«
â”‚
â”œâ”€â”€ è´¦æˆ·é£æ§
â”‚   â”œâ”€â”€ è‡ªæˆäº¤æ£€æµ‹ (DetectSelfTrading)
â”‚   â”œâ”€â”€ å…³è”è´¦æˆ·æ£€æµ‹ (DetectRelatedAccounts)
â”‚   â”œâ”€â”€ é£é™©è¯„åˆ†è®¡ç®— (CalculateRiskScore)
â”‚   â””â”€â”€ è´¦æˆ·å†»ç»“/è§£å†»
â”‚
â””â”€â”€ å®æ—¶ç›‘æ§
    â”œâ”€â”€ å¼‚å¸¸äº¤æ˜“å‘Šè­¦
    â”œâ”€â”€ å¤§é¢è®¢å•å®¡æ ¸
    â””â”€â”€ è¡Œä¸ºåˆ†æå¼•æ“
```

### 5.2 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### åŠŸèƒ½ 1: è®¢å•éªŒè¯

```go
// go-backend/internal/security/risk_manager.go:41-64

func (rm *RiskManager) ValidateOrder(ctx context.Context, order *models.Order, user *models.User) error {
    // [1] è®¢å•é‡‘é¢é™åˆ¶
    orderValue := order.Quantity.Mul(order.Price)
    if orderValue.GreaterThan(rm.maxOrderSize) {
        return fmt.Errorf("order size exceeds maximum allowed: %s", rm.maxOrderSize.String())
    }

    // [2] ä»·æ ¼åç¦»æ£€æµ‹
    if err := rm.checkPriceDeviation(order); err != nil {
        return err
    }

    // [3] è®¢å•é¢‘ç‡é™åˆ¶
    if err := rm.checkOrderFrequency(ctx, user.ID); err != nil {
        return err
    }

    // [4] ç”¨æˆ·çŠ¶æ€æ£€æŸ¥
    if user.Status != 1 {
        return errors.New("user account is not active")
    }

    return nil
}
```

---

#### åŠŸèƒ½ 2: ä»·æ ¼åç¦»æ£€æµ‹

```go
// go-backend/internal/security/risk_manager.go:67-91

func (rm *RiskManager) checkPriceDeviation(order *models.Order) error {
    if order.Type == models.OrderTypeMarket {
        return nil  // å¸‚ä»·å•æ— éœ€æ£€æŸ¥
    }

    // [1] è·å–æœ€æ–°æˆäº¤ä»·
    var lastTrade models.Trade
    if err := database.DB.Where("symbol = ?", order.Symbol).
        Order("trade_time DESC").
        First(&lastTrade).Error; err != nil {
        return nil  // æ— å†å²æˆäº¤,æ”¾è¡Œ
    }

    // [2] è®¡ç®—ä»·æ ¼åç¦»ç‡
    maxDeviation := decimal.NewFromFloat(0.1)  // 10%
    priceDiff := order.Price.Sub(lastTrade.Price).Abs()
    deviationPercent := priceDiff.Div(lastTrade.Price)

    // [3] è¶…è¿‡åç¦»é˜ˆå€¼åˆ™æ‹’ç»
    if deviationPercent.GreaterThan(maxDeviation) {
        return fmt.Errorf("price deviates more than 10%% from market price")
    }

    return nil
}
```

**é˜²æŠ¤åœºæ™¯:**

```
æœ€æ–°æˆäº¤ä»·: 50,000 USDT
ç”¨æˆ·ä¸‹å•ä»·: 60,000 USDT (ä¹°å•)

åç¦»ç‡ = (60,000 - 50,000) / 50,000 = 20%

â†’ è¶…è¿‡10%é˜ˆå€¼,è®¢å•è¢«æ‹’ç»
```

---

#### åŠŸèƒ½ 3: è®¢å•é¢‘ç‡é™åˆ¶

```go
// go-backend/internal/security/risk_manager.go:94-110

func (rm *RiskManager) checkOrderFrequency(ctx context.Context, userID uint) error {
    oneSecondAgo := time.Now().Add(-time.Second)

    var count int64
    if err := database.DB.Model(&models.Order{}).
        Where("user_id = ? AND create_time > ?", userID, oneSecondAgo).
        Count(&count).Error; err != nil {
        return err
    }

    // æ¯ç§’æœ€å¤š10ç¬”è®¢å•
    if count >= int64(rm.orderRateLimit) {
        return errors.New("order rate limit exceeded")
    }

    return nil
}
```

**é™æµç­–ç•¥:**

| é™åˆ¶ç±»å‹ | é˜ˆå€¼ | æ—¶é—´çª—å£ |
|---------|------|---------|
| è®¢å•é¢‘ç‡ | 10ç¬” | 1ç§’ |
| APIè¯·æ±‚ | 100æ¬¡ | 1åˆ†é’Ÿ |

---

#### åŠŸèƒ½ 4: æç°é£æ§

```go
// go-backend/internal/security/risk_manager.go:113-150

func (rm *RiskManager) ValidateWithdrawal(ctx context.Context, withdrawal *models.Withdrawal, user *models.User) error {
    // [1] KYCç­‰çº§æ£€æŸ¥
    if user.KYCLevel == 0 {
        return errors.New("KYC verification required for withdrawal")
    }

    // [2] æ¯æ—¥æç°é™é¢
    limit, exists := rm.dailyWithdrawalLimit[user.KYCLevel]
    if !exists {
        limit = rm.dailyWithdrawalLimit[0]  // é»˜è®¤é™é¢
    }

    // [3] è®¡ç®—ä»Šæ—¥å·²æç°é‡‘é¢
    today := time.Now().Truncate(24 * time.Hour)
    var totalWithdrawn decimal.Decimal

    var withdrawals []models.Withdrawal
    database.DB.Where("user_id = ? AND create_time >= ? AND status IN ?",
        user.ID, today, []int{1, 2, 3}).Find(&withdrawals)

    for _, w := range withdrawals {
        totalWithdrawn = totalWithdrawn.Add(w.Amount)
    }

    // [4] æ£€æŸ¥æ˜¯å¦è¶…é™
    if totalWithdrawn.Add(withdrawal.Amount).GreaterThan(limit) {
        return fmt.Errorf("daily withdrawal limit exceeded: %s", limit.String())
    }

    // [5] æ£€æŸ¥å¯ç–‘æç°æ¨¡å¼
    if err := rm.detectSuspiciousWithdrawal(ctx, withdrawal, user); err != nil {
        return err
    }

    return nil
}
```

**KYCç­‰çº§é™é¢:**

| KYCç­‰çº§ | æ¯æ—¥é™é¢ | è¦æ±‚ |
|---------|---------|------|
| 0 (æœªè®¤è¯) | 0 USDT | ä¸å…è®¸æç° |
| 1 (åŸºç¡€) | 10,000 USDT | èº«ä»½è¯è®¤è¯ |
| 2 (é«˜çº§) | 100,000 USDT | èº«ä»½è¯+åœ°å€è¯æ˜ |

---

#### åŠŸèƒ½ 5: æ´—é’±æ¨¡å¼æ£€æµ‹

```go
// go-backend/internal/security/risk_manager.go:153-183

func (rm *RiskManager) detectSuspiciousWithdrawal(ctx context.Context, withdrawal *models.Withdrawal, user *models.User) error {
    // [1] é¦–æ¬¡æç°åˆ°æ–°åœ°å€
    var count int64
    database.DB.Model(&models.Withdrawal{}).
        Where("user_id = ? AND address = ? AND status = ?", user.ID, withdrawal.Address, 3).
        Count(&count)

    if count == 0 {
        return errors.New("first time withdrawal to this address requires confirmation")
    }

    // [2] å¿«é€Ÿå……å€¼-æç°æ¨¡å¼æ£€æµ‹
    oneHourAgo := time.Now().Add(-time.Hour)
    var recentDeposit models.Deposit
    if err := database.DB.Where("user_id = ? AND create_time > ? AND currency = ?",
        user.ID, oneHourAgo, withdrawal.Currency).
        First(&recentDeposit).Error; err == nil {

        // æç°é‡‘é¢æ¥è¿‘å……å€¼é‡‘é¢ â†’ å¯ç–‘
        diff := recentDeposit.Amount.Sub(withdrawal.Amount).Abs()
        if diff.LessThan(recentDeposit.Amount.Mul(decimal.NewFromFloat(0.1))) {
            return errors.New("suspicious withdrawal pattern detected - manual review required")
        }
    }

    return nil
}
```

**å¯ç–‘æ¨¡å¼ç¤ºä¾‹:**

```
æ—¶é—´è½´:
10:00 - å……å€¼ 10,000 USDT
10:30 - æç° 9,500 USDT (å·®é¢ < 10%)

â†’ è§¦å‘æ´—é’±é¢„è­¦,éœ€è¦äººå·¥å®¡æ ¸
```

---

#### åŠŸèƒ½ 6: é£é™©è¯„åˆ†ç³»ç»Ÿ

```go
// go-backend/internal/security/risk_manager.go:213-267

func (rm *RiskManager) CalculateRiskScore(ctx context.Context, userID uint) (float64, error) {
    var score float64

    // [1] äº¤æ˜“é¢‘ç‡ (æƒé‡20%)
    thirtyDaysAgo := time.Now().Add(-30 * 24 * time.Hour)
    var orderCount int64
    database.DB.Model(&models.Order{}).
        Where("user_id = ? AND create_time > ?", userID, thirtyDaysAgo).
        Count(&orderCount)

    if orderCount > 1000 {
        score += 20  // é«˜é¢‘äº¤æ˜“
    } else if orderCount > 100 {
        score += 10
    } else {
        score += 5  // ä½é¢‘äº¤æ˜“
    }

    // [2] å¤§é¢äº¤æ˜“ (æƒé‡30%)
    var orders []models.Order
    database.DB.Where("user_id = ? AND create_time > ?", userID, thirtyDaysAgo).
        Order("filled_amount DESC").
        Limit(10).
        Find(&orders)

    var totalAmount decimal.Decimal
    for _, order := range orders {
        totalAmount = totalAmount.Add(order.FilledAmount)
    }

    avgAmount, _ := totalAmount.Div(decimal.NewFromInt(int64(len(orders)))).Float64()
    if avgAmount > 100000 {
        score += 30  // å¤§é¢äº¤æ˜“
    } else if avgAmount > 10000 {
        score += 20
    } else {
        score += 10
    }

    // [3] å…³è”è´¦æˆ· (æƒé‡20%)
    relatedAccounts, _ := rm.DetectRelatedAccounts(ctx, userID)
    if len(relatedAccounts) > 5 {
        score += 20  // å¤šä¸ªå…³è”è´¦æˆ·
    } else if len(relatedAccounts) > 0 {
        score += 10
    }

    // [4] åœ°ç†é£é™© (æƒé‡15%) - TODO

    // [5] å†å²è¿è§„ (æƒé‡15%) - TODO

    return score, nil
}
```

**é£é™©è¯„åˆ†ç­‰çº§:**

| åˆ†æ•° | é£é™©ç­‰çº§ | æªæ–½ |
|------|---------|------|
| 0-30 | ä½é£é™© | æ­£å¸¸äº¤æ˜“ |
| 31-60 | ä¸­é£é™© | åŠ å¼ºç›‘æ§ |
| 61-80 | é«˜é£é™© | é™åˆ¶äº¤æ˜“ |
| 81-100 | æé«˜é£é™© | å†»ç»“è´¦æˆ· |

---

## 6. å¹¶å‘å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–

### 6.1 å¹¶å‘æ§åˆ¶ç­–ç•¥

#### è¯»å†™é” (RWMutex)

```go
// è®¢å•ç°¿ä½¿ç”¨è¯»å†™é”
type OrderBook struct {
    Symbol     string
    BuyLevels  map[string]*PriceLevel
    SellLevels map[string]*PriceLevel
    OrderMap   map[string]*models.Order
    mu         sync.RWMutex  // è¯»å†™é”
}

// è¯»æ“ä½œå…è®¸å¹¶å‘
func (ob *OrderBook) GetBestBid() (decimal.Decimal, bool) {
    ob.mu.RLock()         // è¯»é”
    defer ob.mu.RUnlock()
    // ...
}

// å†™æ“ä½œäº’æ–¥
func (ob *OrderBook) AddOrder(order *models.Order) {
    ob.mu.Lock()          // å†™é”
    defer ob.mu.Unlock()
    // ...
}
```

**ä¼˜åŠ¿:**
- å¤šä¸ªgoroutineå¯åŒæ—¶è¯»å–è®¢å•ç°¿
- å†™æ“ä½œæ—¶é˜»å¡æ‰€æœ‰è¯»å†™
- é€‚åˆè¯»å¤šå†™å°‘åœºæ™¯

---

#### äº’æ–¥é” (Mutex)

```go
// æœåŠ¡å±‚ä½¿ç”¨äº’æ–¥é”
type MarginTradingService struct {
    orderService *OrderService
    mutex        sync.RWMutex
    db           *gorm.DB
}

func (s *MarginTradingService) OpenPosition(...) (*MarginPosition, error) {
    s.mutex.Lock()         // äº’æ–¥é”
    defer s.mutex.Unlock()
    // ...
}
```

---

### 6.2 é«˜ç²¾åº¦è®¡ç®—

```go
import "github.com/shopspring/decimal"

// âœ… ä½¿ç”¨ Decimal åº“é¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
price := decimal.NewFromFloat(50000.12345678)
quantity := decimal.NewFromFloat(0.123)
amount := price.Mul(quantity)  // ç²¾ç¡®è®¡ç®—

// âŒ ä¸è¦ä½¿ç”¨ float64 è¿›è¡Œé‡‘èè®¡ç®—
// price := 50000.12345678
// quantity := 0.123
// amount := price * quantity  // å¯èƒ½æœ‰ç²¾åº¦è¯¯å·®
```

**Decimal åº“ä¼˜åŠ¿:**

1. **ä»»æ„ç²¾åº¦**: æ”¯æŒå°æ•°ç‚¹å18ä½ç²¾åº¦
2. **æ— ç²¾åº¦ä¸¢å¤±**: é€‚åˆé‡‘èè®¡ç®—
3. **å†…ç½®æ–¹æ³•**: Add, Sub, Mul, Div, Abs, Neg ç­‰

---

### 6.3 æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•è®¾è®¡

```sql
-- ç”¨æˆ·IDç´¢å¼•
CREATE INDEX idx_user_id ON orders(user_id);
CREATE INDEX idx_user_id ON margin_positions(user_id);

-- ç¬¦å·ç´¢å¼•
CREATE INDEX idx_symbol ON orders(symbol);
CREATE INDEX idx_symbol ON grid_strategies(symbol);

-- çŠ¶æ€ç´¢å¼•
CREATE INDEX idx_status ON orders(status);

-- æ—¶é—´ç´¢å¼•
CREATE INDEX idx_create_time ON orders(create_time);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_user_symbol ON orders(user_id, symbol);
CREATE INDEX idx_symbol_time ON trades(symbol, trade_time DESC);
```

#### è¿æ¥æ± é…ç½®

```go
func InitDatabase(config *Config) error {
    db, err := gorm.Open(postgres.Open(config.PostgresDSN), &gorm.Config{})
    if err != nil {
        return err
    }

    sqlDB, err := db.DB()
    if err != nil {
        return err
    }

    // è¿æ¥æ± é…ç½®
    sqlDB.SetMaxIdleConns(10)           // æœ€å°ç©ºé—²è¿æ¥æ•°
    sqlDB.SetMaxOpenConns(100)          // æœ€å¤§æ‰“å¼€è¿æ¥æ•°
    sqlDB.SetConnMaxLifetime(time.Hour) // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ

    return nil
}
```

---

## 7. æœåŠ¡å¯åŠ¨ä¸ä¾èµ–æ³¨å…¥

### 7.1 ä¸»å‡½æ•°æ¶æ„

```go
// go-backend/cmd/server/main.go:30-76

func main() {
    // [1] åŠ è½½é…ç½®
    loadConfig()

    // [2] åˆå§‹åŒ–æ•°æ®åº“
    dbConfig := &database.Config{
        PostgresDSN: viper.GetString("DATABASE_URL"),
        RedisURL:    viper.GetString("REDIS_URL"),
    }
    database.InitDatabase(dbConfig)
    defer database.Close()

    // [3] åˆå§‹åŒ–æœåŠ¡ (ä¾èµ–æ³¨å…¥)
    matchingEngine := matching.NewMatchingEngine()
    assetService := services.NewAssetService()
    userService := services.NewUserService()
    orderService := services.NewOrderService(matchingEngine, assetService)

    // [4] åˆå§‹åŒ–WebSocket
    hub := websocket.NewHub()
    go hub.Run()

    // [5] å¯åŠ¨æˆäº¤å¤„ç†å™¨
    go processTrades(matchingEngine, hub)

    // [6] åˆå§‹åŒ–HTTPå¤„ç†å™¨
    userHandler := handlers.NewUserHandler(userService, assetService)
    orderHandler := handlers.NewOrderHandler(orderService)
    marketHandler := handlers.NewMarketHandler(orderService)

    // [7] è®¾ç½®è·¯ç”±
    router := setupRouter(userHandler, orderHandler, marketHandler, hub)

    // [8] å¯åŠ¨æœåŠ¡å™¨
    port := viper.GetString("API_PORT")
    log.Printf("Server starting on port %s", port)
    router.Run(":" + port)
}
```

### 7.2 è·¯ç”±é…ç½®

```go
// go-backend/cmd/server/main.go:92-152

func setupRouter(...) *gin.Engine {
    router := gin.Default()

    // ä¸­é—´ä»¶
    router.Use(middleware.CORSMiddleware())
    router.Use(middleware.RateLimitMiddleware())

    // å¥åº·æ£€æŸ¥
    router.GET("/health", func(c *gin.Context) {
        c.JSON(200, gin.H{"status": "ok"})
    })

    // API v1
    v1 := router.Group("/api/v1")
    {
        // å…¬å¼€ç«¯ç‚¹
        auth := v1.Group("/auth")
        {
            auth.POST("/register", userHandler.Register)
            auth.POST("/login", userHandler.Login)
        }

        // å¸‚åœºæ•°æ® (å…¬å¼€)
        market := v1.Group("/market")
        {
            market.GET("/depth/:symbol", marketHandler.GetDepth)
            market.GET("/trades/:symbol", marketHandler.GetTrades)
        }

        // å—ä¿æŠ¤ç«¯ç‚¹ (éœ€è¦JWT)
        authMiddleware := middleware.AuthMiddleware(viper.GetString("JWT_SECRET"))

        order := v1.Group("/order").Use(authMiddleware)
        {
            order.POST("/create", orderHandler.CreateOrder)
            order.DELETE("/:orderId", orderHandler.CancelOrder)
            order.GET("/:orderId", orderHandler.GetOrder)
            order.GET("/open", orderHandler.GetOpenOrders)
            order.GET("/history", orderHandler.GetOrderHistory)
        }

        account := v1.Group("/account").Use(authMiddleware)
        {
            account.GET("/balance", userHandler.GetBalance)
        }
    }

    // WebSocketç«¯ç‚¹
    router.GET("/ws", func(c *gin.Context) {
        handleWebSocket(c, hub)
    })

    return router
}
```

### 7.3 WebSocketé›†æˆ

```go
// go-backend/cmd/server/main.go:180-192

func processTrades(engine *matching.MatchingEngine, hub *websocket.Hub) {
    tradeChan := engine.GetTradeChan()

    for trade := range tradeChan {
        // é€šè¿‡WebSocketå¹¿æ’­æˆäº¤
        hub.BroadcastTrade(trade)

        // å¯æ‰©å±•:
        // - å‘é€é€šçŸ¥
        // - æ›´æ–°ç»Ÿè®¡æ•°æ®
        // - è®°å½•åˆ°å¤–éƒ¨ç³»ç»Ÿ
    }
}
```

---

## 8. æ€»ç»“ä¸æœ€ä½³å®è·µ

### 8.1 æ¶æ„äº®ç‚¹

| äº®ç‚¹ | å®ç° |
|------|------|
| **é«˜æ€§èƒ½æ’®åˆ** | ä»·æ ¼-æ—¶é—´ä¼˜å…ˆç®—æ³•, O(log n)å¤æ‚åº¦ |
| **å¹¶å‘å®‰å…¨** | RWMutexè¯»å†™é”, çº¿ç¨‹å®‰å…¨è®¾è®¡ |
| **é‡‘èç²¾åº¦** | Decimalåº“, 18ä½å°æ•°ç²¾åº¦ |
| **æ¨¡å—åŒ–è®¾è®¡** | 14ä¸ªç‹¬ç«‹æœåŠ¡, æ¸…æ™°çš„èŒè´£åˆ’åˆ† |
| **é£æ§å®Œå–„** | 7å±‚é£æ§æœºåˆ¶, å®æ—¶ç›‘æ§ |
| **å¯æ‰©å±•æ€§** | å¾®æœåŠ¡æ¶æ„, æ˜“äºæ°´å¹³æ‰©å±• |

### 8.2 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

1. **æ•°æ®åº“ä¼˜åŒ–**: ç´¢å¼•è®¾è®¡, è¿æ¥æ± é…ç½®
2. **å¹¶å‘æ§åˆ¶**: è¯»å†™é”, å¼‚æ­¥å¤„ç†
3. **å†…å­˜ç®¡ç†**: å¯¹è±¡æ± , é¿å…é¢‘ç¹GC
4. **ç¼“å­˜ç­–ç•¥**: Redisçƒ­ç‚¹æ•°æ®ç¼“å­˜
5. **æ¶ˆæ¯é˜Ÿåˆ—**: Kafkaå¼‚æ­¥è§£è€¦

### 8.3 å®‰å…¨æœ€ä½³å®è·µ

1. âœ… ä½¿ç”¨JWTè®¤è¯ä¿æŠ¤API
2. âœ… å®æ–½å¤šå±‚é£æ§éªŒè¯
3. âœ… æ—¥å¿—å®¡è®¡å®Œæ•´è®°å½•
4. âœ… æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
5. âœ… é™æµé˜²æ­¢DDoSæ”»å‡»

---

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0
**æœ€åæ›´æ–°:** 2025-11-02
**ä½œè€…**: Aitachi (44158892@qq.com)

**ç›¸å…³æ–‡æ¡£:**
- [æ™ºèƒ½åˆçº¦æ·±åº¦åˆ†æ](./01-æ™ºèƒ½åˆçº¦æ·±åº¦æŠ€æœ¯åˆ†æ.md)
- [é£æ§ç³»ç»Ÿè¯¦è§£](./04-é£æ§ç³»ç»Ÿä¸å®‰å…¨æ¶æ„.md)
- [æ’®åˆå¼•æ“æ€§èƒ½ä¼˜åŒ–](./03-æ’®åˆå¼•æ“æ·±åº¦è§£æ.md)
